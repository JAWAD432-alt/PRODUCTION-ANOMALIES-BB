<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>BAHIA GMAO V7.6</title>
    <style>
        :root{--primary:#1e40af;--primary-l:#3b82f6;--secondary:#f59e0b;--success:#10b981;--danger:#ef4444;--purple:#8b5cf6;--g50:#f8fafc;--g100:#f1f5f9;--g200:#e2e8f0;--g300:#cbd5e1;--g400:#94a3b8;--g500:#64748b;--g600:#475569;--g700:#334155;--g800:#1e293b}
        *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--g100);min-height:100vh;color:var(--g800)}
        .login-page{min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(180deg,var(--primary),var(--primary-l))}
        .login-header{padding:50px 24px 30px;text-align:center;color:#fff}
        .login-header .logo{font-size:56px;margin-bottom:12px}
        .login-header h1{font-size:26px;font-weight:700}
        .login-header p{opacity:.9;font-size:14px;margin-top:6px}
        .login-box{flex:1;background:#fff;border-radius:28px 28px 0 0;padding:28px 20px}
        .login-box h2{font-size:20px;margin-bottom:20px}
        .fg{margin-bottom:16px}
        .fg label{display:block;font-size:13px;font-weight:600;color:var(--g600);margin-bottom:6px}
        .inpbox{position:relative}
        .inpbox .ico{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--g400)}
        .inpbox input{width:100%;padding:14px 14px 14px 46px;border:2px solid var(--g200);border-radius:12px;font-size:15px;background:var(--g50)}
        .inpbox input:focus{outline:none;border-color:var(--primary);background:#fff}
        .inpbox .toggle{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:18px;cursor:pointer;color:var(--g400);padding:4px}
        .remember{display:flex;align-items:center;gap:8px;margin-bottom:20px}
        .remember input{width:18px;height:18px;accent-color:var(--primary)}
        .remember label{font-size:13px;color:var(--g600)}
        .btn-login{width:100%;padding:16px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(30,64,175,.3)}
        .btn-login:disabled{background:var(--g400);box-shadow:none}
        .login-err{background:#fef2f2;border:1px solid #fecaca;color:var(--danger);padding:12px;border-radius:10px;margin-bottom:16px;font-size:13px;display:none}
        .login-footer{text-align:center;margin-top:20px}
        .login-footer a{color:var(--primary);font-size:13px;font-weight:600;text-decoration:none}
        .app{display:none;min-height:100vh;padding-bottom:90px}
        .app.active{display:block}
        .header{background:#fff;padding:12px 16px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .header-row{display:flex;justify-content:space-between;align-items:center}
        .header-left{display:flex;align-items:center;gap:10px}
        .avatar{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-l));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px}
        .user-info h1{font-size:15px;font-weight:700}
        .user-info .role{font-size:12px;color:var(--g500)}
        .header-btns{display:flex;gap:6px}
        .hbtn{width:40px;height:40px;border-radius:10px;background:var(--g100);border:none;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .hbtn.danger{background:#fef2f2}
        .hbtn.print{background:#e0f2fe}
        .status-row{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:8px;padding:6px 12px;background:var(--g50);border-radius:8px;font-size:12px;color:var(--g600)}
        .status-dot{width:8px;height:8px;border-radius:50%}
        .status-dot.on{background:var(--success)}
        .status-dot.off{background:var(--danger)}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:6px 8px 20px;display:flex;justify-content:space-around;box-shadow:0 -4px 20px rgba(0,0,0,.1);z-index:1000}
        .nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 12px;border-radius:12px;background:none;border:none;color:var(--g400);font-size:11px;font-weight:600;cursor:pointer;position:relative}
        .nav-item .nav-ico{font-size:22px}
        .nav-item.active{color:var(--primary);background:#eff6ff}
        .nav-item.hidden{display:none}
        .nav-badge{position:absolute;top:2px;right:2px;background:var(--danger);color:#fff;font-size:10px;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
        .page{display:none;padding:16px;padding-bottom:180px}
        .page.active{display:block}
        .page-title{font-size:22px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px}
        .page-title .refresh{background:var(--g100);border:none;width:36px;height:36px;border-radius:10px;font-size:16px;cursor:pointer;margin-left:auto}
        /* TABS */
        .page-tabs{display:flex;gap:0;background:var(--g100);border-radius:14px;padding:4px;margin-bottom:16px}
        .page-tab{flex:1;padding:12px 8px;border:none;background:transparent;font-size:13px;font-weight:600;color:var(--g500);cursor:pointer;border-radius:10px;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:4px}
        .page-tab.active{background:#fff;color:var(--primary);box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .page-tab .tab-ico{font-size:20px}
        .page-tab .tab-badge{background:var(--danger);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px}
        .tab-content{display:none}
        .tab-content.active{display:block}
        /* Stats */
        .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
        .stat{background:#fff;border-radius:16px;padding:14px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .stat .val{font-size:28px;font-weight:700;color:var(--primary)}
        .stat .lbl{font-size:12px;color:var(--g500);margin-top:2px}
        .stat.warn .val{color:var(--secondary)}
        .stat.ok .val{color:var(--success)}
        .stat.bad .val{color:var(--danger)}
        /* Cards */
        .card{background:#fff;border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .card-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .card-ico{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .card-ico.blue{background:#dbeafe}
        .card-ico.orange{background:#fef3c7}
        .card-ico.green{background:#d1fae5}
        .card-ico.purple{background:#ede9fe}
        .card-ico.red{background:#fee2e2}
        .card-title{font-size:15px;font-weight:700}
        .card-sub{font-size:12px;color:var(--g500)}
        /* Forms */
        .flabel{font-size:13px;font-weight:600;color:var(--g600);margin-bottom:6px;display:block}
        .fselect,.finput,.ftextarea{width:100%;padding:12px 14px;border:2px solid var(--g200);border-radius:10px;font-size:15px;background:var(--g50);color:var(--g800)}
        .fselect:focus,.finput:focus,.ftextarea:focus{outline:none;border-color:var(--primary);background:#fff}
        .fselect{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:40px}
        .ftextarea{resize:none;min-height:80px}
        .textarea-wrap{position:relative}
        .textarea-wrap .ftextarea{padding-right:50px}
        .voice-btn{position:absolute;right:8px;top:8px;width:40px;height:40px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(239,68,68,.3);transition:all .2s}
        .voice-btn:hover{transform:scale(1.1)}
        .voice-btn.recording{animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 0 15px rgba(239,68,68,0)}}
        .user-badge{background:linear-gradient(135deg,var(--primary),var(--primary-l));color:#fff;padding:12px 16px;border-radius:12px;display:flex;align-items:center;gap:10px}
        .user-badge .ub-ico{font-size:24px}
        .user-badge .ub-info{flex:1}
        .user-badge .ub-name{font-weight:700;font-size:15px}
        .user-badge .ub-role{font-size:12px;opacity:.9}
        .chips{display:flex;flex-wrap:wrap;gap:8px}
        .chip{padding:10px 16px;background:var(--g100);border:2px solid var(--g200);border-radius:25px;font-size:14px;font-weight:600;color:var(--g600);cursor:pointer}
        .chip.sel{background:var(--primary);border-color:var(--primary);color:#fff}
        .chip.sm{padding:8px 12px;font-size:12px}
        /* BT Card - CMMS Style */
        .bt-master{background:linear-gradient(135deg,var(--secondary),#d97706);color:#fff;border-radius:16px;padding:16px;margin-bottom:16px}
        .bt-master .bt-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
        .bt-master .bt-id{font-size:20px;font-weight:700}
        .bt-master .bt-status{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:700;background:rgba(255,255,255,.2)}
        .bt-master .bt-status.encours{background:#fef3c7;color:#b45309}
        .bt-master .bt-status.attente{background:#e0e7ff;color:#4338ca}
        .bt-master .bt-status.cloture{background:#d1fae5;color:#059669}
        .bt-master .bt-section{background:rgba(255,255,255,.15);border-radius:10px;padding:10px;margin-bottom:8px}
        .bt-master .bt-section-title{font-size:11px;opacity:.8;margin-bottom:4px;text-transform:uppercase}
        .bt-master .bt-section-value{font-weight:600;font-size:14px}
        .bt-master .bt-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        /* List Items */
        .list-box{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .list-item{padding:14px;border-bottom:1px solid var(--g100);cursor:pointer;position:relative}
        .list-item:last-child{border-bottom:none}
        .list-item.sel{background:#eff6ff}
        .list-row{display:flex;align-items:center;gap:8px;margin-bottom:4px}
        .list-id{font-weight:700;font-size:13px;color:var(--primary)}
        .list-title{font-weight:600;font-size:14px}
        .list-sub{font-size:12px;color:var(--g500)}
        .badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700}
        .badge.warn{background:#fef3c7;color:#b45309}
        .badge.ok{background:#d1fae5;color:#059669}
        .badge.info{background:#e0e7ff;color:#4338ca}
        .badge.danger{background:#fee2e2;color:#dc2626}
        .list-actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:6px}
        .act-btn{width:34px;height:34px;border-radius:8px;border:none;cursor:pointer;font-size:14px}
        .act-btn.edit{background:#dbeafe;color:var(--primary)}
        .act-btn.del{background:#fee2e2;color:var(--danger)}
        /* Search */
        .search{position:relative;margin-bottom:12px}
        .search .sico{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--g400)}
        .search input{width:100%;padding:14px 14px 14px 44px;border:2px solid var(--g200);border-radius:12px;font-size:15px;background:#fff}
        .search input:focus{outline:none;border-color:var(--primary)}
        /* Filters */
        .filters{display:flex;gap:6px;flex-wrap:wrap}
        .fbtn{padding:8px 14px;border:none;background:var(--g100);color:var(--g600);border-radius:20px;font-size:12px;font-weight:600;cursor:pointer}
        .fbtn.active{background:var(--primary);color:#fff}
        /* Timer */
        .timer-sm{background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;padding:16px;border-radius:16px;text-align:center;margin-bottom:12px}
        .timer-box{background:var(--g50);border-radius:12px;padding:16px;text-align:center}
        .timer-display{font-size:32px;font-weight:700;font-family:monospace;color:var(--primary)}
        .timer-btns{display:flex;justify-content:center;gap:8px;margin-top:12px}
        .timer-btn{padding:10px 20px;border:none;border-radius:10px;font-weight:600;cursor:pointer}
        .timer-btn.start{background:var(--success);color:#fff}
        .timer-btn.stop{background:var(--danger);color:#fff}
        .timer-btn.reset{background:var(--g200);color:var(--g700)}
        /* Tech Grid */
        .tech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
        .tech-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--g50);border:2px solid var(--g200);border-radius:10px;cursor:pointer}
        .tech-item.sel{border-color:var(--primary);background:#eff6ff}
        .tech-item input{width:18px;height:18px;accent-color:var(--primary)}
        .tech-name{font-size:13px;font-weight:600;flex:1}
        .sel-tags{font-size:12px;color:var(--g600)}
        .sel-tags .tag{display:inline-block;background:var(--primary);color:#fff;padding:4px 10px;border-radius:12px;margin:2px;font-weight:600}
        /* Photo */
        .photo-btns{display:flex;gap:10px}
        .photo-btn{flex:1;padding:16px;background:var(--g50);border:2px dashed var(--g300);border-radius:12px;text-align:center;cursor:pointer}
        .photo-btn .pico{font-size:28px}
        .photo-btn .plbl{font-size:12px;color:var(--g500);margin-top:4px}
        .photo-btn input{display:none}
        .photo-preview{position:relative;margin-top:12px;border-radius:12px;overflow:hidden}
        .photo-preview img{width:100%;max-height:200px;object-fit:cover}
        .photo-preview .rm{position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:50%;background:var(--danger);color:#fff;border:none;font-size:18px;cursor:pointer}
        /* Duration */
        .dur-row{display:flex;align-items:center;gap:10px}
        .dur-row .finput{width:100px;text-align:center}
        .quick-btns{display:flex;gap:6px;margin-top:10px}
        .qbtn{padding:8px 14px;background:var(--g100);border:none;border-radius:8px;font-weight:600;cursor:pointer}
        /* Preview */
        .preview{background:var(--g800);color:#fff;padding:14px;border-radius:10px;font-family:monospace;font-size:12px;white-space:pre-wrap;line-height:1.5}
        /* Pieces */
        .pieces-box{max-height:250px;overflow-y:auto}
        .piece{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--g100);cursor:pointer}
        .piece:last-child{border-bottom:none}
        .piece.sel{background:#eff6ff}
        .piece input[type="checkbox"]{width:18px;height:18px;accent-color:var(--primary)}
        .piece-info{flex:1}
        .piece-code{font-weight:700;font-size:13px;color:var(--primary)}
        .piece-name{font-size:12px;color:var(--g600)}
        .piece-stock{font-size:11px;color:var(--g400)}
        .piece-qty{width:60px}
        .piece-qty input{width:100%;padding:6px;border:1px solid var(--g300);border-radius:6px;text-align:center}
        /* Success Box */
        .success-box{text-align:center;padding:30px;background:#d1fae5;border-radius:16px}
        .success-box .sico{font-size:50px;margin-bottom:10px}
        .success-box h3{color:var(--success);margin-bottom:6px}
        .success-box p{color:var(--g600);font-size:13px}
        .success-box .sid{font-size:20px;font-weight:700;color:var(--g800);margin-top:10px;font-family:monospace}
        .success-box.orange{background:#fef3c7}
        .success-box.orange h3{color:var(--secondary)}
        .success-box.purple{background:#ede9fe}
        .success-box.purple h3{color:var(--purple)}
        /* Action Bar */
        .action-bar{position:fixed;bottom:76px;left:0;right:0;padding:12px 16px;background:linear-gradient(transparent,var(--g100) 20%);display:none;z-index:500}
        .action-bar.show{display:block}
        .action-btns{display:flex;gap:10px}
        .btn{flex:1;padding:16px;border:none;border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary{background:var(--primary);color:#fff;box-shadow:0 4px 15px rgba(30,64,175,.3)}
        .btn-warning{background:var(--secondary);color:#fff;box-shadow:0 4px 15px rgba(245,158,11,.3)}
        .btn-purple{background:var(--purple);color:#fff;box-shadow:0 4px 15px rgba(139,92,246,.3)}
        .btn:disabled{background:var(--g400);box-shadow:none}
        .btn-wa{width:56px;flex:none;background:#25d366;color:#fff;border-radius:14px}
        .btn-wa svg{width:24px;height:24px;fill:currentColor}
        .btn-reset{width:100%;padding:14px;background:var(--g200);border:none;border-radius:12px;font-size:14px;font-weight:600;color:var(--g700);cursor:pointer;margin-top:10px}
        /* Modal */
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:flex;align-items:flex-end;justify-content:center;z-index:2000}
        .modal.hidden{display:none}
        .modal-box{background:#fff;border-radius:20px 20px 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;padding:20px;animation:slideU .3s}
        @keyframes slideU{from{transform:translateY(100%)}}
        .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .modal-head h3{font-size:18px}
        .modal-close{width:36px;height:36px;border-radius:50%;background:var(--g100);border:none;font-size:20px;cursor:pointer}
        /* BT Info Card */
        .bt-info-card{background:linear-gradient(135deg,var(--primary),var(--primary-l));color:#fff;border-radius:12px;padding:14px;margin-bottom:12px}
        .bt-info-card .bic-id{font-weight:700;font-size:16px;margin-bottom:8px}
        .bt-info-card .bic-row{display:flex;gap:8px;font-size:13px;margin-bottom:4px}
        .bt-info-card .bic-label{opacity:.7}
        /* History Item - Signalement */
        .sig-history-item{padding:14px;border-bottom:1px solid var(--g100);position:relative}
        .sig-history-item:last-child{border-bottom:none}
        .sig-history-item .shi-id{font-weight:700;color:var(--danger);font-size:14px}
        .sig-history-item .shi-date{font-size:11px;color:var(--g400)}
        .sig-history-item .shi-machine{font-weight:600;font-size:15px;margin:4px 0}
        .sig-history-item .shi-anomalie{font-size:13px;color:var(--g600)}
        .sig-history-item .shi-status{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;margin-top:6px}
        .sig-history-item .shi-status.encours{background:#fef3c7;color:#b45309}
        .sig-history-item .shi-status.cloture{background:#d1fae5;color:#059669}
        .sig-history-item .shi-actions{position:absolute;right:12px;top:50%;transform:translateY(-50%);display:flex;gap:6px}
        /* BT History Item */
        .bt-history-item{background:#fff;border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .bt-history-item .bhi-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
        .bt-history-item .bhi-id{font-weight:700;color:var(--secondary);font-size:16px}
        .bt-history-item .bhi-date{font-size:11px;color:var(--g400)}
        .bt-history-item .bhi-sig{background:var(--g50);border-radius:8px;padding:10px;margin-bottom:10px}
        .bt-history-item .bhi-sig-label{font-size:10px;color:var(--g400);text-transform:uppercase;margin-bottom:4px}
        .bt-history-item .bhi-sig-id{font-weight:600;color:var(--danger);font-size:13px}
        .bt-history-item .bhi-machine{font-weight:600;font-size:15px}
        .bt-history-item .bhi-anomalie{font-size:13px;color:var(--g600)}
        .bt-history-item .bhi-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
        .bt-history-item .bhi-detail{background:var(--g50);padding:8px;border-radius:6px}
        .bt-history-item .bhi-detail-label{font-size:10px;color:var(--g400);text-transform:uppercase}
        .bt-history-item .bhi-detail-value{font-size:13px;font-weight:600;color:var(--g700)}
        /* Misc */
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--g800);color:#fff;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:600;z-index:4000;animation:slideD .3s}
        .toast.error{background:var(--danger);color:#fff}
        .toast.info{background:var(--primary);color:#fff}
        @keyframes slideD{from{opacity:0;transform:translateX(-50%) translateY(-20px)}}
        .loading{text-align:center;padding:40px}
        .spinner{width:40px;height:40px;border:4px solid var(--g200);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading p{color:var(--g500);font-size:14px}
        .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000;color:#fff}
        .overlay.hidden{display:none}
        .overlay .spinner{border-color:rgba(255,255,255,.3);border-top-color:#fff}
        .overlay p{margin-top:12px;font-size:15px}
        .empty{text-align:center;padding:30px;color:var(--g500)}
        .empty .eico{font-size:40px;opacity:.5;margin-bottom:10px}
        .hidden{display:none!important}
        .mt12{margin-top:12px}
        .mb12{margin-bottom:12px}
        .edit-banner{background:linear-gradient(135deg,var(--secondary),#d97706);color:#fff;padding:12px 16px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
        .edit-banner .eb-text{font-weight:600}
        .edit-banner button{background:#fff;color:var(--secondary);border:none;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer}
        @media print{body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%}}
        ::-webkit-scrollbar{width:4px;height:4px}
        ::-webkit-scrollbar-thumb{background:var(--g300);border-radius:2px}
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-page" id="loginPage">
        <div class="login-header">
            <div class="logo">üè≠</div>
            <h1>BAHIA AGADIR</h1>
            <p>GMAO - Gestion Maintenance Assist√©e par Ordinateur</p>
        </div>
        <div class="login-box">
            <form class="login-form" onsubmit="handleLogin(event)">
                <h2>Connexion</h2>
                <div class="login-err" id="loginErr"></div>
                <div class="fg">
                    <label>Identifiant</label>
                    <div class="inpbox"><span class="ico">üë§</span><input type="text" id="loginUser" placeholder="Votre identifiant" required></div>
                </div>
                <div class="fg">
                    <label>Mot de passe</label>
                    <div class="inpbox"><span class="ico">üîí</span><input type="password" id="loginPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required><button type="button" class="toggle" onclick="togglePwd('loginPwd')">üëÅÔ∏è</button></div>
                </div>
                <div class="remember"><input type="checkbox" id="rememberMe"><label for="rememberMe">Se souvenir de moi</label></div>
                <button type="submit" class="btn-login" id="btnLogin">Se connecter</button>
                <div class="login-footer"><a href="#" onclick="showConfig()">‚öôÔ∏è Configuration serveur</a></div>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <div class="header">
            <div class="header-row">
                <div class="header-left">
                    <div class="avatar" id="avatar">J</div>
                    <div class="user-info"><h1 id="uName">-</h1><div class="role" id="uRole">-</div></div>
                </div>
                <div class="header-btns">
                    <button class="hbtn print" onclick="showPrintModal()">üñ®Ô∏è</button>
                    <button class="hbtn" onclick="refreshData()">üîÑ</button>
                    <button class="hbtn" onclick="showConfig()">‚öôÔ∏è</button>
                    <button class="hbtn danger" onclick="logout()">üö™</button>
                </div>
            </div>
            <div class="status-row"><span class="status-dot" id="sDot"></span><span id="sText">Connexion...</span></div>
        </div>

        <!-- Dashboard -->
        <div class="page active" id="pgDash">
            <h2 class="page-title">üìä Tableau de bord</h2>
            <div class="stats">
                <div class="stat warn"><div class="val" id="stAno">0</div><div class="lbl">Signalements en cours</div></div>
                <div class="stat ok"><div class="val" id="stBT">0</div><div class="lbl">BT ce mois</div></div>
                <div class="stat bad"><div class="val" id="stStock">0</div><div class="lbl">Stock critique</div></div>
                <div class="stat"><div class="val" id="stSortie">0</div><div class="lbl">Sorties PDR</div></div>
            </div>
            <div class="card">
                <div class="card-head"><div class="card-ico orange">üìã</div><div><div class="card-title">Derniers BT</div></div></div>
                <div id="dashBTList"><div class="empty"><div class="eico">üîß</div>Aucun BT</div></div>
            </div>
        </div>

        <!-- ========== SIGNALEMENT ========== -->
        <div class="page" id="pgSig">
            <h2 class="page-title">üö® Signalement</h2>
            
            <!-- Tabs -->
            <div class="page-tabs">
                <button class="page-tab active" onclick="switchSigTab('nouveau')">
                    <span class="tab-ico">‚ûï</span>Nouveau
                </button>
                <button class="page-tab" onclick="switchSigTab('historique')">
                    <span class="tab-ico">üìã</span>Historique<span class="tab-badge" id="sigHistCount">0</span>
                </button>
            </div>

            <div id="sigLoading" class="loading"><div class="spinner"></div><p>Chargement...</p></div>
            
            <!-- Tab: Nouveau Signalement -->
            <div id="sigTabNouveau" class="tab-content active">
                <!-- Edit Banner -->
                <div class="edit-banner hidden" id="sigEditBanner">
                    <span class="eb-text">‚úèÔ∏è Modification: <span id="sigEditId">-</span></span>
                    <button onclick="cancelSigEdit()">‚úï Annuler</button>
                </div>
                
                <!-- Timer -->
                <div class="timer-sm" id="sigTimerBox">
                    <div style="font-size:12px;opacity:.9;margin-bottom:4px">‚è±Ô∏è Temps d'arr√™t machine</div>
                    <div style="font-size:28px;font-weight:700;font-family:monospace" id="sigTimerVal">00:00:00</div>
                    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
                        <button style="padding:8px 16px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;background:#fff;color:var(--danger)" id="sigTimerStart" onclick="startSigTimer()">‚ñ∂Ô∏è D√©marrer</button>
                        <button style="padding:8px 16px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.2);color:#fff" class="hidden" id="sigTimerStop" onclick="stopSigTimer()">‚èπÔ∏è Stop</button>
                        <button style="padding:8px 16px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.2);color:#fff" onclick="resetSigTimer()">‚Ü∫ Reset</button>
                    </div>
                </div>
                
                <!-- Formulaire -->
                <div class="card" id="sig1"><div class="card-head"><div class="card-ico blue">1</div><div><div class="card-title">Op√©rateur</div></div></div><div class="user-badge"><div class="ub-ico">üë§</div><div class="ub-info"><div class="ub-name" id="sigOpName">-</div><div class="ub-role" id="sigOpRole">-</div></div></div></div>
                <div class="card" id="sig2"><div class="card-head"><div class="card-ico blue">2</div><div><div class="card-title">Ligne</div></div></div><div class="chips" id="sigLignes"></div></div>
                <div class="card hidden" id="sig3"><div class="card-head"><div class="card-ico blue">3</div><div><div class="card-title">Machine</div></div></div><div class="chips" id="sigMachines"></div></div>
                <div class="card hidden" id="sig4"><div class="card-head"><div class="card-ico blue">4</div><div><div class="card-title">Zone</div></div></div><select class="fselect" id="sigZone" onchange="selectSigZone(this.value)"><option value="">-- S√©lectionner --</option></select></div>
                <div class="card hidden" id="sig5"><div class="card-head"><div class="card-ico blue">5</div><div><div class="card-title">Composant</div></div></div><select class="fselect" id="sigComp" onchange="selectSigComp(this.value)"><option value="">-- S√©lectionner --</option></select><input type="text" class="finput mt12 hidden" id="sigCompAutre" placeholder="Pr√©cisez..." oninput="updateSigPreview()"></div>
                <div class="card hidden" id="sig6"><div class="card-head"><div class="card-ico red">6</div><div><div class="card-title">Anomalie</div></div></div><select class="fselect" id="sigAno" onchange="selectSigAno(this.value)"><option value="">-- S√©lectionner --</option></select><input type="text" class="finput mt12 hidden" id="sigAnoAutre" placeholder="D√©crivez..." oninput="updateSigPreview()"></div>
                <div class="card hidden" id="sig7"><div class="card-head"><div class="card-ico orange">7</div><div><div class="card-title">Technicien(s)</div></div></div><div class="tech-grid" id="sigTechs"></div><div class="sel-tags hidden mt12" id="sigSelTechs"></div></div>
                <div class="card hidden" id="sig8"><div class="card-head"><div class="card-ico green">8</div><div><div class="card-title">Dur√©e (manuel)</div></div></div><div class="dur-row"><input type="number" class="finput" id="sigDuree" min="1" placeholder="0" oninput="updateSigPreview()"><span>min</span></div><div class="quick-btns"><button class="qbtn" onclick="setSigDur(5)">5</button><button class="qbtn" onclick="setSigDur(10)">10</button><button class="qbtn" onclick="setSigDur(15)">15</button><button class="qbtn" onclick="setSigDur(30)">30</button><button class="qbtn" onclick="setSigDur(60)">60</button></div></div>
                <div class="card hidden" id="sig9"><div class="card-head"><div class="card-ico purple">9</div><div><div class="card-title">Photo</div></div></div><div class="photo-btns"><label class="photo-btn" for="sigCam"><div class="pico">üì∑</div><div class="plbl">Cam√©ra</div></label><label class="photo-btn" for="sigGal"><div class="pico">üñºÔ∏è</div><div class="plbl">Galerie</div></label></div><input type="file" id="sigCam" accept="image/*" capture="environment" onchange="handleSigPhoto(this)"><input type="file" id="sigGal" accept="image/*" onchange="handleSigPhoto(this)"><div class="photo-preview hidden" id="sigPhotoPreview"><img id="sigPhotoImg" src=""><button class="rm" onclick="removeSigPhoto()">‚úï</button></div></div>
                <div class="card hidden" id="sig10"><div class="card-head"><div class="card-ico blue">10</div><div><div class="card-title">Commentaire</div><div class="card-sub">üé§ Cliquez sur le micro pour dicter</div></div></div><div class="textarea-wrap"><textarea class="ftextarea" id="sigComment" placeholder="D√©tails suppl√©mentaires..." oninput="updateSigPreview()"></textarea><button class="voice-btn" onclick="startVoiceInput('sigComment')" title="Saisie vocale">üé§</button></div></div>
                <div class="card hidden" id="sigPreviewCard"><div class="card-head"><div class="card-ico green">üìã</div><div><div class="card-title">Aper√ßu</div></div></div><div class="preview" id="sigPreview"></div></div>
                <div class="success-box hidden" id="sigSuccess"><div class="sico">‚úÖ</div><h3>Signalement Enregistr√© !</h3><p>Un BT a √©t√© automatiquement cr√©√©</p><div class="sid" id="sigSuccessId">-</div></div>
            </div>
            
            <!-- Tab: Historique Signalements -->
            <div id="sigTabHistorique" class="tab-content">
                <div class="filters mb12">
                    <button class="fbtn active" onclick="filterMySig(this,'all')">Tous</button>
                    <button class="fbtn" onclick="filterMySig(this,'encours')">üîÑ En cours</button>
                    <button class="fbtn" onclick="filterMySig(this,'cloture')">‚úÖ Cl√¥tur√©s</button>
                </div>
                <div class="list-box" id="mySigList"><div class="empty"><div class="eico">üìã</div>Aucun signalement</div></div>
            </div>
        </div>

        <!-- ========== MAINTENANCE ========== -->
        <div class="page" id="pgMaint">
            <h2 class="page-title">üîß Maintenance</h2>
            
            <!-- Tabs -->
            <div class="page-tabs">
                <button class="page-tab active" onclick="switchMaintTab('traitement')">
                    <span class="tab-ico">‚öôÔ∏è</span>Traitement<span class="tab-badge" id="maintOpenCount">0</span>
                </button>
                <button class="page-tab" onclick="switchMaintTab('historique')">
                    <span class="tab-ico">üìã</span>Historique
                </button>
            </div>

            <div id="maintLoading" class="loading"><div class="spinner"></div><p>Chargement...</p></div>
            
            <!-- Tab: Traitement BT -->
            <div id="maintTabTraitement" class="tab-content active">
                <div class="filters mb12">
                    <button class="fbtn active" onclick="filterBT(this,'encours')">üîÑ En cours</button>
                    <button class="fbtn" onclick="filterBT(this,'attente')">‚è≥ Attente pi√®ce</button>
                    <button class="fbtn" onclick="filterBT(this,'all')">üìã Tous ouverts</button>
                </div>
                <div class="search"><span class="sico">üîç</span><input type="text" id="searchBT" placeholder="Rechercher BT, machine..." oninput="filterBTSearch()"></div>
                <div class="list-box mb12" id="btList"></div>
                
                <!-- Formulaire BT -->
                <div class="hidden" id="btForm">
                    <!-- BT Master Card - CMMS Style -->
                    <div class="bt-master">
                        <div class="bt-header">
                            <div class="bt-id" id="btId">BT-YYYYMMDD-XXXX</div>
                            <span class="bt-status encours" id="btStatusBadge">En cours</span>
                        </div>
                        <div class="bt-section">
                            <div class="bt-section-title">üìã Signalement d'origine</div>
                            <div class="bt-section-value" id="btSigRef">ANO-YYYYMMDD-XXXX</div>
                        </div>
                        <div class="bt-grid">
                            <div class="bt-section">
                                <div class="bt-section-title">‚öôÔ∏è Machine</div>
                                <div class="bt-section-value" id="btMachine">-</div>
                            </div>
                            <div class="bt-section">
                                <div class="bt-section-title">üìç Ligne</div>
                                <div class="bt-section-value" id="btLigne">-</div>
                            </div>
                        </div>
                        <div class="bt-section">
                            <div class="bt-section-title">‚ö†Ô∏è Anomalie signal√©e</div>
                            <div class="bt-section-value" id="btAnomalie">-</div>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px">
                            <button style="flex:1;padding:10px;background:rgba(255,255,255,.2);border:none;border-radius:8px;color:#fff;font-weight:600;font-size:12px;cursor:pointer" onclick="quickBtStatus('En cours')">üîÑ En cours</button>
                            <button style="flex:1;padding:10px;background:rgba(255,255,255,.2);border:none;border-radius:8px;color:#fff;font-weight:600;font-size:12px;cursor:pointer" onclick="quickBtStatus('Attente pi√®ce')">‚è≥ Attente</button>
                            <button style="flex:1;padding:10px;background:rgba(255,255,255,.2);border:none;border-radius:8px;color:#fff;font-weight:600;font-size:12px;cursor:pointer" onclick="quickBtStatus('Cl√¥tur√©')">‚úÖ Cl√¥tur√©</button>
                        </div>
                    </div>
                    
                    <div class="card"><div class="card-head"><div class="card-ico orange">üë®‚Äçüîß</div><div><div class="card-title">Technicien responsable</div></div></div><select class="fselect" id="btTech" onchange="updateBtPreview()"><option value="">-- S√©lectionner --</option></select></div>
                    <div class="card"><div class="card-head"><div class="card-ico blue">üîç</div><div><div class="card-title">Diagnostic</div><div class="card-sub">üé§ Utilisez le micro pour dicter</div></div></div><select class="fselect mb12" id="btCause" onchange="updateBtPreview()"><option value="">-- Cause --</option><option>Usure normale</option><option>D√©faut mat√©riel</option><option>Erreur op√©rateur</option><option>Probl√®me r√©glage</option><option>Manque lubrification</option><option>Corps √©tranger</option><option>D√©faut √©lectrique</option><option>D√©faut pneumatique</option><option>Autre</option></select><div class="textarea-wrap"><textarea class="ftextarea" id="btDiag" placeholder="D√©tail diagnostic..." oninput="updateBtPreview()"></textarea><button class="voice-btn" onclick="startVoiceInput('btDiag')" title="Saisie vocale">üé§</button></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico green">üõ†Ô∏è</div><div><div class="card-title">Action corrective</div><div class="card-sub">üé§ Utilisez le micro pour dicter</div></div></div><select class="fselect mb12" id="btAction" onchange="updateBtPreview()"><option value="">-- Action --</option><option>Remplacement pi√®ce</option><option>R√©paration</option><option>R√©glage</option><option>Nettoyage</option><option>Lubrification</option><option>Resserrage</option><option>Autre</option></select><div class="textarea-wrap"><textarea class="ftextarea" id="btActionDetail" placeholder="D√©tail action..." oninput="updateBtPreview()"></textarea><button class="voice-btn" onclick="startVoiceInput('btActionDetail')" title="Saisie vocale">üé§</button></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico purple">üì¶</div><div><div class="card-title">Pi√®ces utilis√©es</div></div></div><div class="search mb12"><span class="sico">üîç</span><input type="text" id="searchPieceBT" placeholder="Rechercher..." oninput="filterPiecesBT()"></div><div class="pieces-box" id="piecesBT"></div><div class="sel-tags hidden mt12" id="selPiecesBT"></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico orange">‚è±Ô∏è</div><div><div class="card-title">Temps intervention</div></div></div><div class="timer-box"><div class="timer-display" id="timerDisplay">00:00:00</div><div class="timer-btns"><button class="timer-btn start" id="timerStart" onclick="startTimer()">‚ñ∂Ô∏è Start</button><button class="timer-btn stop hidden" id="timerStop" onclick="stopTimer()">‚èπÔ∏è Stop</button><button class="timer-btn reset" onclick="resetTimer()">‚Ü∫</button></div></div><div class="dur-row mt12"><span>Ou saisir:</span><input type="number" class="finput" id="btDuree" min="1" placeholder="0" oninput="updateBtPreview()" style="width:80px"><span>min</span></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico green">üìã</div><div><div class="card-title">Aper√ßu BT</div></div></div><div class="preview" id="btPreview"></div></div>
                </div>
                <div class="success-box orange hidden" id="btSuccess"><div class="sico">üîß</div><h3>BT Enregistr√© !</h3><p>Intervention sauvegard√©e</p><div class="sid" id="btSuccessId">-</div></div>
            </div>
            
            <!-- Tab: Historique BT -->
            <div id="maintTabHistorique" class="tab-content">
                <div class="search mb12"><span class="sico">üîç</span><input type="text" id="searchBTHist" placeholder="Rechercher BT cl√¥tur√©..." oninput="filterBTHistSearch()"></div>
                <div id="btHistList"><div class="empty"><div class="eico">üìã</div>Aucun BT cl√¥tur√©</div></div>
            </div>
        </div>

        <!-- ========== PDR ========== -->
        <div class="page" id="pgPDR">
            <h2 class="page-title">üì¶ Gestion PDR <button class="refresh" onclick="refreshData()">üîÑ</button></h2>
            <div id="pdrLoading" class="loading"><div class="spinner"></div><p>Chargement...</p></div>
            <div id="pdrApp" class="hidden">
                <div class="stats mb12">
                    <div class="stat"><div class="val" id="pdrTotal">0</div><div class="lbl">Total r√©f√©rences</div></div>
                    <div class="stat bad"><div class="val" id="pdrBas">0</div><div class="lbl">Stock critique</div></div>
                </div>
                
                <!-- S√©lection BT -->
                <div class="card">
                    <div class="card-head"><div class="card-ico orange">üîß</div><div><div class="card-title">Lier au Bon de Travail</div><div class="card-sub">Les infos machine/anomalie seront auto-remplies</div></div></div>
                    <div class="search"><span class="sico">üîç</span><input type="text" id="pdrBtSearch" placeholder="Rechercher BT-..." oninput="searchPdrBT()"></div>
                    <div id="pdrBtResults" style="max-height:150px;overflow-y:auto"></div>
                </div>
                
                <!-- Infos BT s√©lectionn√© -->
                <div class="bt-info-card hidden" id="pdrBtInfo">
                    <div class="bic-id" id="pdrBtId">-</div>
                    <div class="bic-row"><span class="bic-label">Machine:</span><span id="pdrBtMachine">-</span></div>
                    <div class="bic-row"><span class="bic-label">Anomalie:</span><span id="pdrBtAnomalie">-</span></div>
                    <button onclick="clearPdrBT()" style="margin-top:8px;padding:6px 12px;background:rgba(255,255,255,.2);border:none;border-radius:6px;color:#fff;font-size:12px;cursor:pointer">‚úï Changer de BT</button>
                </div>
                
                <div class="card"><div class="card-head"><div class="card-ico purple">üì§</div><div><div class="card-title">Motif de sortie</div></div></div>
                    <select class="fselect" id="pdrMotif" onchange="updatePdrPreview()"><option value="">-- S√©lectionner --</option><option>Maintenance corrective</option><option>Maintenance pr√©ventive</option><option>Remplacement usure</option><option>Stock tampon</option><option>Autre</option></select>
                </div>
                
                <div class="card"><div class="card-head"><div class="card-ico purple">üîß</div><div><div class="card-title">Pi√®ces √† sortir</div></div></div>
                    <div class="search mb12"><span class="sico">üîç</span><input type="text" id="searchPiecePDR" placeholder="Rechercher pi√®ce..." oninput="filterPiecesPDR()"></div>
                    <div class="filters mb12">
                        <button class="fbtn active" onclick="filterPdrType(this,'all')">Tous</button>
                        <button class="fbtn" onclick="filterPdrType(this,'M√©canique')">M√©ca</button>
                        <button class="fbtn" onclick="filterPdrType(this,'√âlectrique')">√âlec</button>
                        <button class="fbtn" onclick="filterPdrType(this,'Pneumatique')">Pneum</button>
                    </div>
                    <div class="pieces-box" id="piecesPDR"></div>
                    <div class="sel-tags hidden mt12" id="selPiecesPDR"></div>
                </div>
                
                <div class="card hidden" id="pdrPreviewCard"><div class="card-head"><div class="card-ico green">üìã</div><div><div class="card-title">Aper√ßu</div></div></div><div class="preview" id="pdrPreview"></div></div>
                <div class="success-box purple hidden" id="pdrSuccess"><div class="sico">üì¶</div><h3>Sortie Enregistr√©e !</h3><p>Stock mis √† jour</p><div class="sid" id="pdrSuccessId">-</div></div>
                
                <div class="card mt12"><div class="card-head"><div class="card-ico red">üìä</div><div><div class="card-title">Historique sorties</div></div></div>
                    <div style="max-height:200px;overflow-y:auto">
                        <table style="width:100%;font-size:11px;border-collapse:collapse">
                            <thead style="background:var(--purple);color:#fff"><tr><th style="padding:6px;text-align:left">Date</th><th>Code</th><th>Qt√©</th><th>BT</th></tr></thead>
                            <tbody id="pdrHistory"><tr><td colspan="4" style="text-align:center;padding:20px;color:var(--g400)">Aucune sortie</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="goPage('pgDash',this)"><span class="nav-ico">üìä</span>Accueil</button>
            <button class="nav-item" id="navSig" onclick="goPage('pgSig',this)"><span class="nav-ico">üö®</span>Signaler</button>
            <button class="nav-item" id="navMaint" onclick="goPage('pgMaint',this)"><span class="nav-ico">üîß</span>Maintenance<span class="nav-badge hidden" id="badgeBT">0</span></button>
            <button class="nav-item" id="navPDR" onclick="goPage('pgPDR',this)"><span class="nav-ico">üì¶</span>PDR</button>
        </div>

        <!-- Action Bars -->
        <div class="action-bar" id="actionSig">
            <div class="action-btns" id="sigBtns"><button class="btn btn-primary" id="btnSaveSig" onclick="saveSig()" disabled>üíæ Enregistrer</button><button class="btn btn-wa" id="btnWaSig" onclick="sendWaSig()" disabled><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button></div>
            <button class="btn-reset hidden" id="btnResetSig" onclick="resetSig()">üîÑ Nouveau signalement</button>
        </div>
        <div class="action-bar" id="actionMaint">
            <div class="action-btns" id="maintBtns"><button class="btn btn-warning" id="btnSaveBT" onclick="saveBT()" disabled>üíæ Enregistrer BT</button><button class="btn btn-wa" id="btnWaBT" onclick="sendWaBT()" disabled><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button></div>
            <button class="btn-reset hidden" id="btnResetBT" onclick="resetBT()">üîÑ Nouvelle intervention</button>
        </div>
        <div class="action-bar" id="actionPDR">
            <div class="action-btns" id="pdrBtns"><button class="btn btn-purple" id="btnSavePDR" onclick="savePDR()" disabled>üíæ Valider sortie</button></div>
            <button class="btn-reset hidden" id="btnResetPDR" onclick="resetPDR()">üîÑ Nouvelle sortie</button>
        </div>
    </div>

    <!-- Config Modal -->
    <div class="modal hidden" id="configModal">
        <div class="modal-box">
            <div class="modal-head"><h3>‚öôÔ∏è Configuration</h3><button class="modal-close" onclick="hideConfig()">‚úï</button></div>
            <div class="fg"><label>URL Google Apps Script</label><input type="url" class="finput" id="cfgUrl" placeholder="https://script.google.com/..."></div>
            <div class="fg"><label>Token d'acc√®s</label><input type="text" class="finput" id="cfgToken" placeholder="Votre token secret"></div>
            <button class="btn btn-primary" onclick="saveConfig()" style="width:100%">üíæ Sauvegarder</button>
        </div>
    </div>

    <!-- Print Modal -->
    <div class="modal hidden" id="printModal">
        <div class="modal-box">
            <div class="modal-head"><h3>üñ®Ô∏è Imprimer</h3><button class="modal-close" onclick="hidePrintModal()">‚úï</button></div>
            <div style="display:flex;flex-direction:column;gap:10px">
                <button class="btn btn-primary" onclick="printReport('sig')">üìã Signalements</button>
                <button class="btn btn-warning" onclick="printReport('bt')">üîß Bons de Travail</button>
                <button class="btn btn-purple" onclick="printReport('pdr')">üì¶ Sorties PDR</button>
            </div>
        </div>
    </div>

    <!-- Voice Modal -->
    <div class="modal hidden" id="voiceModal">
        <div class="modal-box">
            <div class="modal-head"><h3>üé§ Saisie Vocale - 100% Gratuit</h3><button class="modal-close" onclick="closeVoiceModal()">‚úï</button></div>
            <div style="display:flex;gap:8px;margin-bottom:16px">
                <button class="fbtn active" onclick="setVoiceLang('fr-FR')" id="langFR">üá´üá∑ Fran√ßais</button>
                <button class="fbtn" onclick="setVoiceLang('ar-MA')" id="langAR">üá≤üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
            </div>
            <div style="text-align:center;padding:20px">
                <button id="voiceRecordBtn" onclick="toggleVoiceRecord()" style="width:80px;height:80px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;font-size:32px;cursor:pointer;box-shadow:0 4px 20px rgba(239,68,68,.4)">üé§</button>
                <p style="margin-top:12px;color:var(--g500);font-size:13px" id="voiceStatus">Appuyez pour parler</p>
            </div>
            <textarea class="ftextarea" id="voiceText" placeholder="Le texte appara√Ætra ici..." style="min-height:100px"></textarea>
            <div style="display:flex;gap:10px;margin-top:12px">
                <button class="btn" style="flex:1;background:var(--g200);color:var(--g700)" onclick="closeVoiceModal()">Annuler</button>
                <button class="btn btn-primary" style="flex:1" onclick="confirmVoice()">‚úì Confirmer</button>
            </div>
            <p style="text-align:center;margin-top:12px;font-size:11px;color:var(--g400)">Web Speech API - Aucune cl√© requise</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden"></div>

    <!-- Overlay -->
    <div class="overlay hidden" id="overlay"><div class="spinner"></div><p id="overlayText">Chargement...</p></div>

    <!-- Print Area -->
    <div id="printArea" class="print-area"></div>

<script>
    // ============ CONFIG ============
    const ROLES={admin:{sig:true,maint:true,pdr:true,edit:true},technicien:{sig:false,maint:true,pdr:true,edit:true},operateur:{sig:true,maint:false,pdr:false,edit:false},magasinier:{sig:false,maint:false,pdr:true,edit:true}};
    
    // ============ STATE ============
    let user=null,db=null,allAno=[],allBT=[],allPieces=[],history=[];
    let currentBTFilter='encours',currentPdrType='all',mySigFilter='all';
    let sigData={ligne:'',machine:'',zone:'',comp:'',ano:'',techs:[]};
    let btData={bt:null,statut:'En cours',pieces:[]};
    let pdrData={bt:null,machine:'',anomalie:'',pieces:[]};
    let sigPhoto=null,sigPhotoUrl=null,savedSigId=null,savedBtId=null;
    let sigTimerInterval=null,sigTimerSeconds=0;
    let timerInterval=null,timerSeconds=0;
    let editMode=null,editId=null;
    let voiceTargetField=null,speechRecognition=null,voiceLang='fr-FR',isRecording=false,finalTranscript='';

    // ============ INIT ============
    document.addEventListener('DOMContentLoaded',()=>{
        const saved=localStorage.getItem('bahia_user');
        if(saved){user=JSON.parse(saved);showApp()}
        else document.getElementById('loginPage').style.display='flex';
        initSpeechRecognition();
    });

    // ============ AUTH ============
    function togglePwd(id){const i=document.getElementById(id);i.type=i.type==='password'?'text':'password'}
    async function handleLogin(e){
        e.preventDefault();
        const u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPwd').value;
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        if(!url||!token){showLoginErr('Configurez d\'abord le serveur');return}
        document.getElementById('btnLogin').disabled=true;
        try{
            const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'login',token,username:u,password:p})});
            const res=await r.json();
            if(res.error)throw new Error(res.error);
            user=res.user;
            if(document.getElementById('rememberMe').checked)localStorage.setItem('bahia_user',JSON.stringify(user));
            showApp();
        }catch(err){showLoginErr(err.message)}
        document.getElementById('btnLogin').disabled=false;
    }
    function showLoginErr(m){const e=document.getElementById('loginErr');e.textContent=m;e.style.display='block'}
    function logout(){localStorage.removeItem('bahia_user');user=null;location.reload()}

    // ============ APP ============
    function showApp(){
        document.getElementById('loginPage').style.display='none';
        document.getElementById('app').classList.add('active');
        document.getElementById('uName').textContent=user.nom;
        document.getElementById('uRole').textContent=user.role;
        document.getElementById('avatar').textContent=user.nom.charAt(0).toUpperCase();
        // Permissions
        const r=ROLES[user.role]||{};
        document.getElementById('navSig').classList.toggle('hidden',!r.sig);
        document.getElementById('navMaint').classList.toggle('hidden',!r.maint);
        document.getElementById('navPDR').classList.toggle('hidden',!r.pdr);
        loadData();
    }

    async function loadData(){
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        if(!url||!token){setStatus(false,'Non configur√©');return}
        try{
            const r=await fetch(`${url}?token=${encodeURIComponent(token)}`);
            db=await r.json();
            if(db.error)throw new Error(db.error);
            setStatus(true,'Connect√©');
            allPieces=db.pieces||[];
            initSig();initMaint();initPDR();
            loadAllData();
        }catch(e){setStatus(false,'Erreur');console.error(e)}
    }

    async function loadAllData(){
        await loadAnomalies();
        await loadBTs();
        loadHistory();
        updateDashboard();
    }

    function refreshData(){loadAllData();toast('üîÑ Donn√©es actualis√©es')}
    function setStatus(ok,txt){document.getElementById('sDot').className='status-dot '+(ok?'on':'off');document.getElementById('sText').textContent=txt}
    function goPage(id,el){
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        document.querySelectorAll('.action-bar').forEach(a=>a.classList.remove('show'));
        document.getElementById(id).classList.add('active');
        if(el)el.classList.add('active');
        if(id==='pgSig')document.getElementById('actionSig').classList.add('show');
        if(id==='pgMaint')document.getElementById('actionMaint').classList.add('show');
        if(id==='pgPDR')document.getElementById('actionPDR').classList.add('show');
    }

    // ============ SIGNALEMENT ============
    function initSig(){
        document.getElementById('sigLoading').classList.add('hidden');
        document.getElementById('sigOpName').textContent=user.nom;
        document.getElementById('sigOpRole').textContent=user.role;
        const lignes=[...new Set((db.machines||[]).map(m=>m.Ligne))];
        document.getElementById('sigLignes').innerHTML=lignes.map(l=>`<div class="chip" onclick="selectSigLigne(this,'${l}')">${l}</div>`).join('');
        document.getElementById('sigTechs').innerHTML=(db.techniciens||[]).map(t=>`<div class="tech-item" onclick="toggleSigTech(this,'${t.Nom}')"><input type="checkbox"><span class="tech-name">${t.Nom}</span></div>`).join('');
        document.getElementById('sigAno').innerHTML='<option value="">-- S√©lectionner --</option>'+(db.anomalies||[]).map(a=>`<option value="${a.Anomalie}">${a.Anomalie}</option>`).join('')+'<option value="Autre">‚ûï Autre</option>';
    }
    
    function switchSigTab(tab){
        document.querySelectorAll('#pgSig .page-tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('#pgSig .tab-content').forEach(c=>c.classList.remove('active'));
        if(tab==='nouveau'){
            document.querySelector('#pgSig .page-tab:first-child').classList.add('active');
            document.getElementById('sigTabNouveau').classList.add('active');
        }else{
            document.querySelector('#pgSig .page-tab:last-child').classList.add('active');
            document.getElementById('sigTabHistorique').classList.add('active');
            loadMySignalements();
        }
    }

    function selectSigLigne(el,v){document.querySelectorAll('#sigLignes .chip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');sigData.ligne=v;sigData.machine='';sigData.zone='';sigData.comp='';sigData.ano='';const m=(db.machines||[]).filter(x=>x.Ligne===v);document.getElementById('sigMachines').innerHTML=m.map(x=>`<div class="chip" onclick="selectSigMachine(this,'${x.Machine}')">${x.Machine}</div>`).join('');show(['sig3']);hide(['sig4','sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function selectSigMachine(el,v){document.querySelectorAll('#sigMachines .chip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');sigData.machine=v;sigData.zone='';sigData.comp='';sigData.ano='';const z=(db.zones||[]).filter(x=>x.Machine===v);document.getElementById('sigZone').innerHTML='<option value="">-- S√©lectionner --</option>'+z.map(x=>`<option value="${x.Zone}">${x.Zone}</option>`).join('');show(['sig4']);hide(['sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function selectSigZone(v){sigData.zone=v;sigData.comp='';sigData.ano='';const c=(db.composants||[]).filter(x=>x.Zone===v);document.getElementById('sigComp').innerHTML='<option value="">-- S√©lectionner --</option>'+c.map(x=>`<option value="${x.Composant}">${x.Composant}</option>`).join('')+'<option value="Autre">‚ûï Autre</option>';show(['sig5']);hide(['sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function selectSigComp(v){sigData.comp=v;sigData.ano='';document.getElementById('sigCompAutre').classList.toggle('hidden',v!=='Autre');show(['sig6']);hide(['sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function selectSigAno(v){sigData.ano=v;document.getElementById('sigAnoAutre').classList.toggle('hidden',v!=='Autre');show(['sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function toggleSigTech(el,n){el.classList.toggle('sel');el.querySelector('input').checked=el.classList.contains('sel');if(el.classList.contains('sel')){if(!sigData.techs.includes(n))sigData.techs.push(n)}else{sigData.techs=sigData.techs.filter(t=>t!==n)}const d=document.getElementById('sigSelTechs');d.classList.toggle('hidden',!sigData.techs.length);d.innerHTML='<strong>S√©lectionn√©s:</strong> '+sigData.techs.map(t=>`<span class="tag">${t}</span>`).join('');updateSigPreview()}
    function setSigDur(v){document.getElementById('sigDuree').value=v;updateSigPreview()}
    function handleSigPhoto(inp){const f=inp.files[0];if(!f)return;sigPhoto=f;const r=new FileReader();r.onload=e=>{sigPhotoUrl=e.target.result;document.getElementById('sigPhotoImg').src=sigPhotoUrl;document.getElementById('sigPhotoPreview').classList.remove('hidden')};r.readAsDataURL(f)}
    function removeSigPhoto(){sigPhoto=sigPhotoUrl=null;document.getElementById('sigPhotoPreview').classList.add('hidden');document.getElementById('sigCam').value='';document.getElementById('sigGal').value=''}
    function startSigTimer(){if(sigTimerInterval)return;document.getElementById('sigTimerStart').classList.add('hidden');document.getElementById('sigTimerStop').classList.remove('hidden');sigTimerInterval=setInterval(()=>{sigTimerSeconds++;updateSigTimerDisplay()},1000)}
    function stopSigTimer(){clearInterval(sigTimerInterval);sigTimerInterval=null;document.getElementById('sigTimerStart').classList.remove('hidden');document.getElementById('sigTimerStop').classList.add('hidden')}
    function resetSigTimer(){clearInterval(sigTimerInterval);sigTimerInterval=null;sigTimerSeconds=0;updateSigTimerDisplay();document.getElementById('sigTimerStart').classList.remove('hidden');document.getElementById('sigTimerStop').classList.add('hidden')}
    function updateSigTimerDisplay(){const h=Math.floor(sigTimerSeconds/3600),m=Math.floor((sigTimerSeconds%3600)/60),s=sigTimerSeconds%60;document.getElementById('sigTimerVal').textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}
    function updateSigPreview(){const comp=sigData.comp==='Autre'?document.getElementById('sigCompAutre').value:sigData.comp;const ano=sigData.ano==='Autre'?document.getElementById('sigAnoAutre').value:sigData.ano;const dur=sigTimerSeconds>0?Math.ceil(sigTimerSeconds/60):document.getElementById('sigDuree').value;let m=`üö® *SIGNALEMENT ANOMALIE*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;m+=`üë§ ${user.nom}\n`;if(sigData.ligne)m+=`üìç ${sigData.ligne}\n`;if(sigData.machine)m+=`‚öôÔ∏è ${sigData.machine}\n`;if(sigData.zone)m+=`üîß ${sigData.zone}\n`;if(comp)m+=`üî© ${comp}\n`;if(ano)m+=`‚ö†Ô∏è ${ano}\n`;if(sigData.techs.length)m+=`üë®‚Äçüîß ${sigData.techs.join(', ')}\n`;if(dur)m+=`‚è±Ô∏è ${dur} min\n`;const c=document.getElementById('sigComment').value;if(c)m+=`üí¨ ${c}\n`;document.getElementById('sigPreview').textContent=m;const ok=sigData.ligne&&sigData.machine&&sigData.zone&&(sigData.comp||(sigData.comp==='Autre'&&document.getElementById('sigCompAutre').value))&&(sigData.ano||(sigData.ano==='Autre'&&document.getElementById('sigAnoAutre').value));document.getElementById('btnSaveSig').disabled=!ok;document.getElementById('btnWaSig').disabled=!ok}

    async function saveSig(){
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        showOverlay(editMode==='sig'?'Modification...':'Enregistrement...');
        try{
            const dur=sigTimerSeconds>0?Math.ceil(sigTimerSeconds/60):document.getElementById('sigDuree').value;
            const d={
                action:editMode==='sig'?'updateAnomalie':'saveAnomalie',
                token,id:editId,
                operateur:user.nom,
                ligne:sigData.ligne,
                machine:sigData.machine,
                zone:sigData.zone,
                composant:sigData.comp==='Autre'?document.getElementById('sigCompAutre').value:sigData.comp,
                anomalie:sigData.ano==='Autre'?document.getElementById('sigAnoAutre').value:sigData.ano,
                techniciens:sigData.techs.join(', '),
                duree:dur,
                commentaire:document.getElementById('sigComment').value,
                photo:sigPhotoUrl||'',
                userId:user?.id
            };
            const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(d)});
            const res=await r.json();
            hideOverlay();
            if(res.error)throw new Error(res.error);
            savedSigId=res.id||editId;
            document.getElementById('sigSuccessId').textContent=savedSigId+(res.btId?' ‚Üí '+res.btId:'');
            document.querySelectorAll('#sigTabNouveau > .card, #sigTabNouveau > .timer-sm, #sigTabNouveau > .edit-banner').forEach(c=>c.classList.add('hidden'));
            document.getElementById('sigSuccess').classList.remove('hidden');
            document.getElementById('sigBtns').classList.add('hidden');
            document.getElementById('btnResetSig').classList.remove('hidden');
            toast(editMode==='sig'?'‚úÖ Signalement modifi√©':'‚úÖ Signalement + BT cr√©√©s');
            editMode=null;editId=null;
            await loadAllData();
            // Basculer vers historique apr√®s 2s
            setTimeout(()=>{switchSigTab('historique')},2000);
        }catch(e){hideOverlay();toast('‚ùå '+e.message,'error')}
    }

    function resetSig(){
        editMode=null;editId=null;
        document.getElementById('sigEditBanner').classList.add('hidden');
        sigData={ligne:'',machine:'',zone:'',comp:'',ano:'',techs:[]};
        sigPhoto=sigPhotoUrl=savedSigId=null;
        resetSigTimer();
        document.getElementById('sigDuree').value='';
        document.getElementById('sigComment').value='';
        document.querySelectorAll('#sigLignes .chip,#sigMachines .chip,.tech-item').forEach(c=>c.classList.remove('sel'));
        document.querySelectorAll('.tech-item input').forEach(c=>c.checked=false);
        document.getElementById('sigSelTechs').classList.add('hidden');
        removeSigPhoto();
        document.getElementById('sigSuccess').classList.add('hidden');
        document.querySelectorAll('#sigTabNouveau > .card, #sigTabNouveau > .timer-sm').forEach(c=>c.classList.remove('hidden'));
        hide(['sig3','sig4','sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);
        document.getElementById('sigBtns').classList.remove('hidden');
        document.getElementById('btnResetSig').classList.add('hidden');
        updateSigPreview();
    }

    function editAnomalie(id){
        const ano=allAno.find(a=>a.ID===id);
        if(!ano)return;
        editMode='sig';editId=id;
        switchSigTab('nouveau');
        document.getElementById('sigEditBanner').classList.remove('hidden');
        document.getElementById('sigEditId').textContent=id;
        setTimeout(()=>{
            sigData.ligne=ano.Ligne||'';
            sigData.machine=ano.Machine||'';
            sigData.zone=ano.Zone||'';
            sigData.comp=ano.Composant||'';
            sigData.ano=ano.Anomalie||'';
            sigData.techs=(ano.Techniciens||'').split(', ').filter(t=>t);
            document.querySelectorAll('#sigLignes .chip').forEach(c=>{if(c.textContent===ano.Ligne)c.classList.add('sel')});
            const m=(db.machines||[]).filter(x=>x.Ligne===ano.Ligne);
            document.getElementById('sigMachines').innerHTML=m.map(x=>`<div class="chip ${x.Machine===ano.Machine?'sel':''}" onclick="selectSigMachine(this,'${x.Machine}')">${x.Machine}</div>`).join('');
            const z=(db.zones||[]).filter(x=>x.Machine===ano.Machine);
            document.getElementById('sigZone').innerHTML='<option value="">-- S√©lectionner --</option>'+z.map(x=>`<option value="${x.Zone}" ${x.Zone===ano.Zone?'selected':''}>${x.Zone}</option>`).join('');
            const c=(db.composants||[]).filter(x=>x.Zone===ano.Zone);
            document.getElementById('sigComp').innerHTML='<option value="">-- S√©lectionner --</option>'+c.map(x=>`<option value="${x.Composant}" ${x.Composant===ano.Composant?'selected':''}>${x.Composant}</option>`).join('')+'<option value="Autre">‚ûï Autre</option>';
            document.querySelectorAll('.tech-item').forEach(el=>{const n=el.querySelector('.tech-name').textContent;if(sigData.techs.includes(n)){el.classList.add('sel');el.querySelector('input').checked=true}});
            document.getElementById('sigDuree').value=ano.Duree||'';
            document.getElementById('sigComment').value=ano.Commentaire||'';
            show(['sig3','sig4','sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);
            updateSigPreview();
            toast('‚úèÔ∏è Mode √©dition','info');
        },100);
    }

    function cancelSigEdit(){editMode=null;editId=null;document.getElementById('sigEditBanner').classList.add('hidden');resetSig();toast('Mode √©dition annul√©')}

    async function deleteAnomalie(id){
        if(!confirm(`Supprimer le signalement ${id} ?`))return;
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        showOverlay('Suppression...');
        try{
            const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action:'deleteAnomalie',token,id})});
            const res=await r.json();hideOverlay();
            if(res.error)throw new Error(res.error);
            toast('üóëÔ∏è Signalement supprim√©');
            loadAllData();
        }catch(e){hideOverlay();toast('‚ùå '+e.message,'error')}
    }

    // Historique signalements op√©rateur
    function loadMySignalements(){
        const myAno=allAno.filter(a=>a.User_ID===user?.id||a.Operateur===user?.nom);
        document.getElementById('sigHistCount').textContent=myAno.length;
        filterMySig(document.querySelector('#sigTabHistorique .filters .fbtn.active'),mySigFilter);
    }
    function filterMySig(el,type){
        document.querySelectorAll('#sigTabHistorique .filters .fbtn').forEach(b=>b.classList.remove('active'));
        if(el)el.classList.add('active');
        mySigFilter=type;
        let myAno=allAno.filter(a=>a.User_ID===user?.id||a.Operateur===user?.nom);
        if(type==='encours')myAno=myAno.filter(a=>!a.Statut||a.Statut==='En cours'||a.Statut==='Attente pi√®ce');
        else if(type==='cloture')myAno=myAno.filter(a=>a.Statut==='Cl√¥tur√©');
        renderMySigList(myAno);
    }
    function renderMySigList(list){
        const d=document.getElementById('mySigList');
        if(!list.length){d.innerHTML='<div class="empty"><div class="eico">üìã</div>Aucun signalement</div>';return}
        d.innerHTML=list.map(a=>{
            const status=a.Statut||'En cours';
            const statusClass=status==='Cl√¥tur√©'?'cloture':'encours';
            return`<div class="sig-history-item">
                <div class="shi-id">üìã ${a.ID}</div>
                <div class="shi-date">${a.Date||''} ${a.Heure||''}</div>
                <div class="shi-machine">${a.Machine||'-'}</div>
                <div class="shi-anomalie">${a.Anomalie||'-'}</div>
                <span class="shi-status ${statusClass}">${status}</span>
                <div class="shi-actions">
                    <button class="act-btn edit" onclick="editAnomalie('${a.ID}')" title="Modifier">‚úèÔ∏è</button>
                    <button class="act-btn del" onclick="deleteAnomalie('${a.ID}')" title="Supprimer">üóëÔ∏è</button>
                </div>
            </div>`
        }).join('');
    }

    // ============ MAINTENANCE ============
    function initMaint(){
        document.getElementById('maintLoading').classList.add('hidden');
        document.getElementById('btTech').innerHTML='<option value="">-- S√©lectionner --</option>'+(db.techniciens||[]).map(t=>`<option value="${t.Nom}">${t.Nom}</option>`).join('');
        renderPieces('piecesBT','bt');
    }

    function switchMaintTab(tab){
        document.querySelectorAll('#pgMaint .page-tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('#pgMaint .tab-content').forEach(c=>c.classList.remove('active'));
        if(tab==='traitement'){
            document.querySelector('#pgMaint .page-tab:first-child').classList.add('active');
            document.getElementById('maintTabTraitement').classList.add('active');
        }else{
            document.querySelector('#pgMaint .page-tab:last-child').classList.add('active');
            document.getElementById('maintTabHistorique').classList.add('active');
            renderBTHistory();
        }
    }

    async function loadAnomalies(){
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        try{
            const r=await fetch(`${url}?token=${encodeURIComponent(token)}&action=getAnomaliesEnCours`);
            const res=await r.json();
            allAno=res.anomalies||[];
            loadMySignalements();
        }catch(e){console.error(e)}
    }

    async function loadBTs(){
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        try{
            const r=await fetch(`${url}?token=${encodeURIComponent(token)}&action=getBonsTravail`);
            const res=await r.json();
            allBT=res.bts||[];
            filterBT(document.querySelector('#maintTabTraitement .filters .fbtn.active'),currentBTFilter);
            updateBTCounts();
        }catch(e){console.error(e);allBT=[]}
    }

    function updateBTCounts(){
        const open=allBT.filter(b=>b.Statut!=='Cl√¥tur√©').length;
        document.getElementById('maintOpenCount').textContent=open;
        document.getElementById('badgeBT').textContent=open;
        document.getElementById('badgeBT').classList.toggle('hidden',open===0);
    }

    function filterBT(el,type){
        document.querySelectorAll('#maintTabTraitement .filters .fbtn').forEach(b=>b.classList.remove('active'));
        el.classList.add('active');
        currentBTFilter=type;
        let f=allBT.filter(b=>b.Statut!=='Cl√¥tur√©');
        if(type==='encours')f=allBT.filter(b=>b.Statut==='En cours');
        else if(type==='attente')f=allBT.filter(b=>b.Statut==='Attente pi√®ce');
        renderBTList(f);
    }

    function filterBTSearch(){
        const s=document.getElementById('searchBT').value.toLowerCase();
        const f=allBT.filter(b=>b.Statut!=='Cl√¥tur√©').filter(b=>
            b.BT_ID?.toLowerCase().includes(s)||
            b.Machine?.toLowerCase().includes(s)||
            b.Anomalie_ID?.toLowerCase().includes(s)
        );
        renderBTList(f);
    }

    function renderBTList(list){
        const d=document.getElementById('btList');
        if(!list.length){d.innerHTML='<div class="empty"><div class="eico">üîß</div>Aucun BT ouvert</div>';return}
        d.innerHTML=list.map(bt=>{
            const statusClass=bt.Statut==='En cours'?'warn':(bt.Statut==='Attente pi√®ce'?'info':'ok');
            return`<div class="list-item" onclick="selectBT('${bt.BT_ID}')">
                <div class="list-row">
                    <span class="list-id">üîß ${bt.BT_ID}</span>
                    <span class="badge ${statusClass}">${bt.Statut||'En cours'}</span>
                </div>
                <div class="list-title">${bt.Machine||'-'}</div>
                <div class="list-sub">üìã ${bt.Anomalie_ID||'-'} | ${bt.Date||''}</div>
            </div>`
        }).join('');
    }

    function selectBT(btId){
        const bt=allBT.find(b=>b.BT_ID===btId);
        if(!bt)return;
        btData.bt=bt;
        btData.statut=bt.Statut||'En cours';
        btData.pieces=[];
        try{btData.pieces=JSON.parse(bt.Pieces||'[]')}catch(e){}
        
        // Remplir le master card
        document.getElementById('btId').textContent=bt.BT_ID;
        document.getElementById('btSigRef').textContent=bt.Anomalie_ID||'-';
        document.getElementById('btMachine').textContent=bt.Machine||'-';
        document.getElementById('btLigne').textContent=bt.Ligne||'-';
        document.getElementById('btAnomalie').textContent=bt.Anomalie||'-';
        updateBtStatusBadge(btData.statut);
        
        // Remplir le formulaire
        document.getElementById('btTech').value=bt.Technicien||'';
        document.getElementById('btCause').value=bt.Cause||'';
        document.getElementById('btDiag').value=bt.Diagnostic||'';
        document.getElementById('btAction').value=bt.Action||'';
        document.getElementById('btActionDetail').value=bt.Action_Detail||'';
        document.getElementById('btDuree').value=bt.Duree||'';
        
        renderPieces('piecesBT','bt');
        updateSelPieces('bt');
        document.getElementById('btForm').classList.remove('hidden');
        updateBtPreview();
        
        document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('sel'));
        event.currentTarget.classList.add('sel');
    }

    function updateBtStatusBadge(status){
        const badge=document.getElementById('btStatusBadge');
        badge.textContent=status;
        badge.className='bt-status '+(status==='En cours'?'encours':(status==='Attente pi√®ce'?'attente':'cloture'));
    }

    function quickBtStatus(v){
        btData.statut=v;
        updateBtStatusBadge(v);
        updateBtPreview();
    }

    function renderPieces(cid,mode){
        const d=document.getElementById(cid),arr=mode==='bt'?btData.pieces:pdrData.pieces;
        let list=allPieces;
        if(mode==='pdr'&&currentPdrType!=='all')list=allPieces.filter(p=>p.Type===currentPdrType);
        if(!list.length){d.innerHTML='<div class="empty" style="padding:20px"><div class="eico">üì¶</div>Aucune pi√®ce</div>';return}
        d.innerHTML=list.map((p,i)=>{
            const s=arr.find(x=>x.code===p.Code_JDE);
            return`<div class="piece ${s?'sel':''}" onclick="togglePiece(${allPieces.indexOf(p)},'${mode}')"><input type="checkbox" ${s?'checked':''}><div class="piece-info"><div class="piece-code">${p.Code_JDE}</div><div class="piece-name">${p.Designation}</div><div class="piece-stock">Stock: ${p.Stock||0} ${p.Unite||'U'}</div></div><div class="piece-qty ${s?'':'hidden'}"><input type="number" min="1" value="${s?.qty||1}" onchange="updatePieceQty(${allPieces.indexOf(p)},this.value,'${mode}')" onclick="event.stopPropagation()"></div></div>`
        }).join('');
    }

    function togglePiece(i,mode){
        const p=allPieces[i],arr=mode==='bt'?btData.pieces:pdrData.pieces;
        const idx=arr.findIndex(x=>x.code===p.Code_JDE);
        if(idx>=0)arr.splice(idx,1);
        else arr.push({code:p.Code_JDE,designation:p.Designation,qty:1,unite:p.Unite||'U'});
        renderPieces(mode==='bt'?'piecesBT':'piecesPDR',mode);
        updateSelPieces(mode);
        if(mode==='bt')updateBtPreview();else updatePdrPreview();
    }

    function updatePieceQty(i,q,mode){
        const p=allPieces[i],arr=mode==='bt'?btData.pieces:pdrData.pieces;
        const it=arr.find(x=>x.code===p.Code_JDE);
        if(it)it.qty=parseInt(q)||1;
        updateSelPieces(mode);
        if(mode==='bt')updateBtPreview();else updatePdrPreview();
    }

    function updateSelPieces(mode){
        const arr=mode==='bt'?btData.pieces:pdrData.pieces;
        const d=document.getElementById(mode==='bt'?'selPiecesBT':'selPiecesPDR');
        d.classList.toggle('hidden',!arr.length);
        d.innerHTML='<strong>S√©lectionn√©es:</strong><br>'+arr.map(p=>`<span class="tag">${p.code} x${p.qty}</span>`).join('');
    }

    function filterPiecesBT(){
        const s=document.getElementById('searchPieceBT').value.toLowerCase();
        const f=allPieces.filter(p=>p.Code_JDE.toLowerCase().includes(s)||p.Designation.toLowerCase().includes(s));
        renderFilteredPieces('piecesBT',f,'bt');
    }

    function renderFilteredPieces(cid,list,mode){
        const d=document.getElementById(cid),arr=mode==='bt'?btData.pieces:pdrData.pieces;
        if(!list.length){d.innerHTML='<div class="empty" style="padding:20px">Aucune pi√®ce trouv√©e</div>';return}
        d.innerHTML=list.map(p=>{
            const i=allPieces.indexOf(p),s=arr.find(x=>x.code===p.Code_JDE);
            return`<div class="piece ${s?'sel':''}" onclick="togglePiece(${i},'${mode}')"><input type="checkbox" ${s?'checked':''}><div class="piece-info"><div class="piece-code">${p.Code_JDE}</div><div class="piece-name">${p.Designation}</div><div class="piece-stock">Stock: ${p.Stock||0} ${p.Unite||'U'}</div></div><div class="piece-qty ${s?'':'hidden'}"><input type="number" min="1" value="${s?.qty||1}" onchange="updatePieceQty(${i},this.value,'${mode}')" onclick="event.stopPropagation()"></div></div>`
        }).join('');
    }

    function startTimer(){if(timerInterval)return;document.getElementById('timerStart').classList.add('hidden');document.getElementById('timerStop').classList.remove('hidden');timerInterval=setInterval(()=>{timerSeconds++;updateTimerDisplay()},1000)}
    function stopTimer(){clearInterval(timerInterval);timerInterval=null;document.getElementById('timerStart').classList.remove('hidden');document.getElementById('timerStop').classList.add('hidden');document.getElementById('btDuree').value=Math.ceil(timerSeconds/60);updateBtPreview()}
    function resetTimer(){clearInterval(timerInterval);timerInterval=null;timerSeconds=0;updateTimerDisplay();document.getElementById('timerStart').classList.remove('hidden');document.getElementById('timerStop').classList.add('hidden')}
    function updateTimerDisplay(){const h=Math.floor(timerSeconds/3600),m=Math.floor((timerSeconds%3600)/60),s=timerSeconds%60;document.getElementById('timerDisplay').textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}

    function updateBtPreview(){
        const bt=btData.bt;
        const t=document.getElementById('btTech').value;
        const c=document.getElementById('btCause').value;
        const diag=document.getElementById('btDiag').value;
        const act=document.getElementById('btAction').value;
        const det=document.getElementById('btActionDetail').value;
        const dur=document.getElementById('btDuree').value;
        
        let m=`üîß *BON DE TRAVAIL*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        m+=`üìã ${bt?.BT_ID||'-'}\n`;
        m+=`üìé Sig: ${bt?.Anomalie_ID||'-'}\n`;
        m+=`‚öôÔ∏è ${bt?.Machine||'-'}\n`;
        m+=`‚ö†Ô∏è ${bt?.Anomalie||'-'}\n`;
        m+=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        if(t)m+=`üë®‚Äçüîß ${t}\n`;
        if(c)m+=`üîç ${c}\n`;
        if(diag)m+=`üìù ${diag}\n`;
        if(act)m+=`üõ†Ô∏è ${act}\n`;
        if(det)m+=`üìù ${det}\n`;
        if(btData.pieces.length){m+=`üì¶ Pi√®ces:\n`;btData.pieces.forEach(p=>m+=`   ‚Ä¢ ${p.code} x${p.qty}\n`)}
        if(dur)m+=`‚è±Ô∏è ${dur} min\n`;
        if(btData.statut)m+=`‚úÖ ${btData.statut}\n`;
        
        document.getElementById('btPreview').textContent=m;
        const ok=bt&&btData.statut;
        document.getElementById('btnSaveBT').disabled=!ok;
        document.getElementById('btnWaBT').disabled=!bt;
    }

    async function saveBT(){
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        showOverlay('Enregistrement BT...');
        try{
            const d={
                action:'updateBT',
                token,
                btId:btData.bt.BT_ID,
                technicien:document.getElementById('btTech').value,
                cause:document.getElementById('btCause').value,
                diagnostic:document.getElementById('btDiag').value,
                actionType:document.getElementById('btAction').value,
                actionDetail:document.getElementById('btActionDetail').value,
                pieces:JSON.stringify(btData.pieces),
                duree:document.getElementById('btDuree').value,
                statut:btData.statut,
                userId:user?.id
            };
            const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(d)});
            const res=await r.json();
            hideOverlay();
            if(res.error)throw new Error(res.error);
            savedBtId=btData.bt.BT_ID;
            document.getElementById('btSuccessId').textContent=savedBtId;
            document.querySelectorAll('#maintTabTraitement > .card,#maintTabTraitement > .filters,#maintTabTraitement > .search,#maintTabTraitement > .list-box,#btForm').forEach(c=>c.classList.add('hidden'));
            document.getElementById('btSuccess').classList.remove('hidden');
            document.getElementById('maintBtns').classList.add('hidden');
            document.getElementById('btnResetBT').classList.remove('hidden');
            toast('‚úÖ BT enregistr√©');
            await loadAllData();
            // Si cl√¥tur√©, basculer vers historique
            if(btData.statut==='Cl√¥tur√©'){
                setTimeout(()=>{switchMaintTab('historique')},2000);
            }
        }catch(e){hideOverlay();toast('‚ùå '+e.message,'error')}
    }

    function resetBT(){
        btData={bt:null,statut:'En cours',pieces:[]};
        document.getElementById('btForm').classList.add('hidden');
        document.getElementById('btSuccess').classList.add('hidden');
        document.querySelectorAll('#maintTabTraitement > .card,#maintTabTraitement > .filters,#maintTabTraitement > .search,#maintTabTraitement > .list-box').forEach(c=>c.classList.remove('hidden'));
        document.getElementById('maintBtns').classList.remove('hidden');
        document.getElementById('btnResetBT').classList.add('hidden');
        document.getElementById('btTech').value='';
        document.getElementById('btCause').value='';
        document.getElementById('btDiag').value='';
        document.getElementById('btAction').value='';
        document.getElementById('btActionDetail').value='';
        document.getElementById('btDuree').value='';
        resetTimer();
        document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('sel'));
        filterBT(document.querySelector('#maintTabTraitement .filters .fbtn.active'),currentBTFilter);
    }

    // Historique BT (cl√¥tur√©s)
    function renderBTHistory(){
        const closed=allBT.filter(b=>b.Statut==='Cl√¥tur√©');
        const d=document.getElementById('btHistList');
        if(!closed.length){d.innerHTML='<div class="empty"><div class="eico">üìã</div>Aucun BT cl√¥tur√©</div>';return}
        d.innerHTML=closed.slice(0,30).map(bt=>`
            <div class="bt-history-item">
                <div class="bhi-header">
                    <div class="bhi-id">üîß ${bt.BT_ID}</div>
                    <div class="bhi-date">${bt.Date||''}</div>
                </div>
                <div class="bhi-sig">
                    <div class="bhi-sig-label">Signalement d'origine</div>
                    <div class="bhi-sig-id">üìã ${bt.Anomalie_ID||'-'}</div>
                </div>
                <div class="bhi-machine">${bt.Machine||'-'}</div>
                <div class="bhi-anomalie">${bt.Anomalie||'-'}</div>
                <div class="bhi-details">
                    <div class="bhi-detail"><div class="bhi-detail-label">Technicien</div><div class="bhi-detail-value">${bt.Technicien||'-'}</div></div>
                    <div class="bhi-detail"><div class="bhi-detail-label">Dur√©e</div><div class="bhi-detail-value">${bt.Duree||'-'} min</div></div>
                    <div class="bhi-detail"><div class="bhi-detail-label">Cause</div><div class="bhi-detail-value">${bt.Cause||'-'}</div></div>
                    <div class="bhi-detail"><div class="bhi-detail-label">Action</div><div class="bhi-detail-value">${bt.Action||'-'}</div></div>
                </div>
            </div>
        `).join('');
    }

    function filterBTHistSearch(){
        const s=document.getElementById('searchBTHist').value.toLowerCase();
        const f=allBT.filter(b=>b.Statut==='Cl√¥tur√©').filter(b=>
            b.BT_ID?.toLowerCase().includes(s)||
            b.Machine?.toLowerCase().includes(s)||
            b.Anomalie_ID?.toLowerCase().includes(s)
        );
        renderBTHistFiltered(f);
    }

    function renderBTHistFiltered(list){
        const d=document.getElementById('btHistList');
        if(!list.length){d.innerHTML='<div class="empty"><div class="eico">üìã</div>Aucun BT trouv√©</div>';return}
        d.innerHTML=list.slice(0,30).map(bt=>`
            <div class="bt-history-item">
                <div class="bhi-header">
                    <div class="bhi-id">üîß ${bt.BT_ID}</div>
                    <div class="bhi-date">${bt.Date||''}</div>
                </div>
                <div class="bhi-sig">
                    <div class="bhi-sig-label">Signalement d'origine</div>
                    <div class="bhi-sig-id">üìã ${bt.Anomalie_ID||'-'}</div>
                </div>
                <div class="bhi-machine">${bt.Machine||'-'}</div>
                <div class="bhi-anomalie">${bt.Anomalie||'-'}</div>
                <div class="bhi-details">
                    <div class="bhi-detail"><div class="bhi-detail-label">Technicien</div><div class="bhi-detail-value">${bt.Technicien||'-'}</div></div>
                    <div class="bhi-detail"><div class="bhi-detail-label">Dur√©e</div><div class="bhi-detail-value">${bt.Duree||'-'} min</div></div>
                </div>
            </div>
        `).join('');
    }

    // ============ PDR ============
    function initPDR(){
        document.getElementById('pdrLoading').classList.add('hidden');
        document.getElementById('pdrApp').classList.remove('hidden');
        document.getElementById('pdrTotal').textContent=allPieces.length;
        document.getElementById('pdrBas').textContent=allPieces.filter(p=>(p.Stock||0)<(p.Seuil||5)).length;
        renderPieces('piecesPDR','pdr');
    }

    // Recherche BT pour PDR
    function searchPdrBT(){
        const s=document.getElementById('pdrBtSearch').value.toLowerCase().trim();
        const d=document.getElementById('pdrBtResults');
        if(!s){d.innerHTML='';return}
        const results=allBT.filter(b=>b.Statut!=='Cl√¥tur√©').filter(b=>
            b.BT_ID?.toLowerCase().includes(s)||
            b.Machine?.toLowerCase().includes(s)
        ).slice(0,5);
        if(!results.length){d.innerHTML='<div style="padding:10px;color:var(--g400);text-align:center">Aucun BT trouv√©</div>';return}
        d.innerHTML=results.map(bt=>`
            <div style="padding:10px;border-bottom:1px solid var(--g100);cursor:pointer" onclick="selectPdrBT('${bt.BT_ID}')">
                <div style="font-weight:600;color:var(--secondary)">${bt.BT_ID}</div>
                <div style="font-size:12px;color:var(--g500)">${bt.Machine||'-'} | ${bt.Statut}</div>
            </div>
        `).join('');
    }

    function selectPdrBT(btId){
        const bt=allBT.find(b=>b.BT_ID===btId);
        if(!bt)return;
        pdrData.bt=bt;
        pdrData.machine=bt.Machine||'';
        pdrData.anomalie=bt.Anomalie||'';
        
        // Afficher les infos BT
        document.getElementById('pdrBtInfo').classList.remove('hidden');
        document.getElementById('pdrBtId').textContent=bt.BT_ID;
        document.getElementById('pdrBtMachine').textContent=bt.Machine||'-';
        document.getElementById('pdrBtAnomalie').textContent=bt.Anomalie||'-';
        
        // Cacher la recherche
        document.getElementById('pdrBtSearch').value='';
        document.getElementById('pdrBtResults').innerHTML='';
        
        updatePdrPreview();
        toast('üîß BT s√©lectionn√©','info');
    }

    function clearPdrBT(){
        pdrData.bt=null;
        pdrData.machine='';
        pdrData.anomalie='';
        document.getElementById('pdrBtInfo').classList.add('hidden');
        updatePdrPreview();
    }

    function filterPiecesPDR(){
        const s=document.getElementById('searchPiecePDR').value.toLowerCase();
        let list=allPieces;
        if(currentPdrType!=='all')list=list.filter(p=>p.Type===currentPdrType);
        const f=list.filter(p=>p.Code_JDE.toLowerCase().includes(s)||p.Designation.toLowerCase().includes(s));
        renderFilteredPieces('piecesPDR',f,'pdr');
    }

    function filterPdrType(el,type){
        document.querySelectorAll('#pgPDR .filters .fbtn').forEach(b=>b.classList.remove('active'));
        el.classList.add('active');
        currentPdrType=type;
        renderPieces('piecesPDR','pdr');
    }

    function updatePdrPreview(){
        const bt=pdrData.bt;
        const motif=document.getElementById('pdrMotif').value;
        
        let m=`üì¶ *SORTIE PDR*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        if(bt){
            m+=`üîß ${bt.BT_ID}\n`;
            m+=`‚öôÔ∏è ${bt.Machine||'-'}\n`;
            m+=`‚ö†Ô∏è ${bt.Anomalie||'-'}\n`;
        }
        if(motif)m+=`üìã ${motif}\n`;
        if(pdrData.pieces.length){
            m+=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            m+=`üì¶ Pi√®ces:\n`;
            pdrData.pieces.forEach(p=>m+=`   ‚Ä¢ ${p.code} x${p.qty}\n`);
        }
        
        document.getElementById('pdrPreview').textContent=m;
        document.getElementById('pdrPreviewCard').classList.toggle('hidden',!pdrData.pieces.length);
        
        const ok=bt&&motif&&pdrData.pieces.length>0;
        document.getElementById('btnSavePDR').disabled=!ok;
    }

    async function savePDR(){
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        showOverlay('Enregistrement sortie...');
        try{
            const d={
                action:'saveSortiePDR',
                token,
                btId:pdrData.bt?.BT_ID||'',
                machine:pdrData.bt?.Machine||'',
                motif:document.getElementById('pdrMotif').value,
                pieces:JSON.stringify(pdrData.pieces),
                userId:user?.id
            };
            const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(d)});
            const res=await r.json();
            hideOverlay();
            if(res.error)throw new Error(res.error);
            document.getElementById('pdrSuccessId').textContent=res.sortieId||'OK';
            document.querySelectorAll('#pdrApp > .card,#pdrApp > .stats').forEach(c=>c.classList.add('hidden'));
            document.getElementById('pdrSuccess').classList.remove('hidden');
            document.getElementById('pdrBtns').classList.add('hidden');
            document.getElementById('btnResetPDR').classList.remove('hidden');
            toast('‚úÖ Sortie enregistr√©e');
            loadHistory();
        }catch(e){hideOverlay();toast('‚ùå '+e.message,'error')}
    }

    function resetPDR(){
        pdrData={bt:null,machine:'',anomalie:'',pieces:[]};
        document.getElementById('pdrMotif').value='';
        clearPdrBT();
        document.getElementById('pdrSuccess').classList.add('hidden');
        document.querySelectorAll('#pdrApp > .card,#pdrApp > .stats').forEach(c=>c.classList.remove('hidden'));
        document.getElementById('pdrBtns').classList.remove('hidden');
        document.getElementById('btnResetPDR').classList.add('hidden');
        renderPieces('piecesPDR','pdr');
        updatePdrPreview();
    }

    async function loadHistory(){
        const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');
        try{
            const r=await fetch(`${url}?token=${encodeURIComponent(token)}&action=getHistoriqueSorties`);
            const res=await r.json();
            history=res.sorties||[];
            renderHistory();
        }catch(e){console.error(e)}
    }

    function renderHistory(){
        const t=document.getElementById('pdrHistory');
        if(!history.length){t.innerHTML='<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--g400)">Aucune sortie</td></tr>';return}
        t.innerHTML=history.slice(0,30).map(s=>`<tr><td style="padding:6px">${formatDate(s.Date)}</td><td style="padding:6px;font-weight:600;color:var(--primary)">${s.Code_JDE||''}</td><td style="padding:6px;text-align:center">${s.Quantite||''}</td><td style="padding:6px;font-size:10px;color:var(--secondary)">${s.BT_Ref||'-'}</td></tr>`).join('');
    }

    // ============ DASHBOARD ============
    function updateDashboard(){
        const anoEnCours=allAno.filter(a=>!a.Statut||a.Statut==='En cours'||a.Statut==='Attente pi√®ce').length;
        const btCeMois=allBT.filter(b=>{
            const d=b.Date;if(!d)return false;
            const now=new Date();
            const m=d.split('/');if(m.length<2)return false;
            return parseInt(m[1])===now.getMonth()+1;
        }).length;
        const stockBas=allPieces.filter(p=>(p.Stock||0)<(p.Seuil||5)).length;
        
        document.getElementById('stAno').textContent=anoEnCours;
        document.getElementById('stBT').textContent=btCeMois;
        document.getElementById('stStock').textContent=stockBas;
        document.getElementById('stSortie').textContent=history.length;
        
        // Derniers BT
        const lastBT=allBT.slice(0,5);
        const d=document.getElementById('dashBTList');
        if(!lastBT.length){d.innerHTML='<div class="empty"><div class="eico">üîß</div>Aucun BT</div>';return}
        d.innerHTML=lastBT.map(bt=>`
            <div style="padding:10px;border-bottom:1px solid var(--g100)">
                <div style="display:flex;justify-content:space-between">
                    <span style="font-weight:600;color:var(--secondary)">${bt.BT_ID}</span>
                    <span class="badge ${bt.Statut==='Cl√¥tur√©'?'ok':'warn'}">${bt.Statut||'En cours'}</span>
                </div>
                <div style="font-size:13px;margin-top:2px">${bt.Machine||'-'}</div>
                <div style="font-size:11px;color:var(--g400)">${bt.Date||''}</div>
            </div>
        `).join('');
    }

    // ============ VOICE ============
    function initSpeechRecognition(){
        const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
        if(!SR){console.warn('Web Speech API non support√©e');return}
        speechRecognition=new SR();
        speechRecognition.lang=voiceLang;
        speechRecognition.continuous=true;
        speechRecognition.interimResults=true;
        speechRecognition.onresult=(event)=>{
            let interim='';
            for(let i=event.resultIndex;i<event.results.length;i++){
                const t=event.results[i][0].transcript;
                if(event.results[i].isFinal)finalTranscript+=t+' ';
                else interim+=t;
            }
            document.getElementById('voiceText').value=finalTranscript+interim;
        };
        speechRecognition.onerror=(event)=>{
            let msg='Erreur';
            if(event.error==='not-allowed')msg='Acc√®s micro refus√©';
            else if(event.error==='no-speech')msg='Aucune parole d√©tect√©e';
            else if(event.error==='network')msg='Erreur r√©seau';
            document.getElementById('voiceStatus').textContent=msg;
            stopVoiceRecording();
        };
        speechRecognition.onend=()=>{if(isRecording)speechRecognition.start()};
    }

    function startVoiceInput(fieldId){
        if(!speechRecognition){toast('Saisie vocale non disponible','error');return}
        voiceTargetField=fieldId;
        finalTranscript=document.getElementById(fieldId).value;
        document.getElementById('voiceText').value=finalTranscript;
        document.getElementById('voiceModal').classList.remove('hidden');
    }

    function setVoiceLang(lang){
        voiceLang=lang;
        if(speechRecognition)speechRecognition.lang=lang;
        document.getElementById('langFR').classList.toggle('active',lang==='fr-FR');
        document.getElementById('langAR').classList.toggle('active',lang==='ar-MA');
    }

    function toggleVoiceRecord(){
        if(isRecording)stopVoiceRecording();
        else startVoiceRecording();
    }

    function startVoiceRecording(){
        if(!speechRecognition)return;
        isRecording=true;
        speechRecognition.lang=voiceLang;
        speechRecognition.start();
        document.getElementById('voiceRecordBtn').style.background='linear-gradient(135deg,#22c55e,#16a34a)';
        document.getElementById('voiceRecordBtn').textContent='‚èπÔ∏è';
        document.getElementById('voiceStatus').textContent='üî¥ Parlez maintenant...';
    }

    function stopVoiceRecording(){
        if(!speechRecognition)return;
        isRecording=false;
        speechRecognition.stop();
        document.getElementById('voiceRecordBtn').style.background='linear-gradient(135deg,var(--danger),#dc2626)';
        document.getElementById('voiceRecordBtn').textContent='üé§';
        document.getElementById('voiceStatus').textContent='Appuyez pour parler';
    }

    function confirmVoice(){
        const text=document.getElementById('voiceText').value.trim();
        if(voiceTargetField&&text)document.getElementById(voiceTargetField).value=text;
        closeVoiceModal();
        if(voiceTargetField==='sigComment')updateSigPreview();
        else if(voiceTargetField==='btDiag'||voiceTargetField==='btActionDetail')updateBtPreview();
    }

    function closeVoiceModal(){
        stopVoiceRecording();
        document.getElementById('voiceModal').classList.add('hidden');
        voiceTargetField=null;
        finalTranscript='';
    }

    // ============ UTILS ============
    function show(ids){ids.forEach(id=>document.getElementById(id)?.classList.remove('hidden'))}
    function hide(ids){ids.forEach(id=>document.getElementById(id)?.classList.add('hidden'))}
    function toast(m,type=''){const t=document.getElementById('toast');t.textContent=m;t.className=type;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),3000)}
    function showOverlay(m){document.getElementById('overlayText').textContent=m;document.getElementById('overlay').classList.remove('hidden')}
    function hideOverlay(){document.getElementById('overlay').classList.add('hidden')}
    function formatDate(d){if(!d)return'-';const p=d.split('/');if(p.length===3)return`${p[0]}/${p[1]}`;return d}
    function showConfig(){document.getElementById('cfgUrl').value=localStorage.getItem('bahia_url')||'';document.getElementById('cfgToken').value=localStorage.getItem('bahia_token')||'';document.getElementById('configModal').classList.remove('hidden')}
    function hideConfig(){document.getElementById('configModal').classList.add('hidden')}
    function saveConfig(){const u=document.getElementById('cfgUrl').value.trim(),t=document.getElementById('cfgToken').value.trim();if(u)localStorage.setItem('bahia_url',u);if(t)localStorage.setItem('bahia_token',t);hideConfig();toast('‚úÖ Configuration sauvegard√©e');if(user)loadData()}
    function showPrintModal(){document.getElementById('printModal').classList.remove('hidden')}
    function hidePrintModal(){document.getElementById('printModal').classList.add('hidden')}

    function printReport(type){
        hidePrintModal();
        let html='<style>body{font-family:Arial,sans-serif;padding:20px}h1{color:#1e40af}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background:#1e40af;color:#fff}.logo{text-align:center;margin-bottom:20px}.logo img{height:60px}</style>';
        html+='<div class="logo"><h1>üè≠ BAHIA AGADIR - GMAO</h1></div>';
        
        if(type==='sig'){
            html+='<h2>üìã Signalements</h2><table><thead><tr><th>ID</th><th>Date</th><th>Machine</th><th>Anomalie</th><th>Statut</th></tr></thead><tbody>';
            allAno.forEach(a=>{html+=`<tr><td>${a.ID}</td><td>${a.Date||''}</td><td>${a.Machine||''}</td><td>${a.Anomalie||''}</td><td>${a.Statut||'En cours'}</td></tr>`});
            html+='</tbody></table>';
        }else if(type==='bt'){
            html+='<h2>üîß Bons de Travail</h2><table><thead><tr><th>BT</th><th>Signalement</th><th>Date</th><th>Machine</th><th>Technicien</th><th>Statut</th></tr></thead><tbody>';
            allBT.forEach(b=>{html+=`<tr><td>${b.BT_ID}</td><td>${b.Anomalie_ID||''}</td><td>${b.Date||''}</td><td>${b.Machine||''}</td><td>${b.Technicien||''}</td><td>${b.Statut||''}</td></tr>`});
            html+='</tbody></table>';
        }else if(type==='pdr'){
            html+='<h2>üì¶ Sorties PDR</h2><table><thead><tr><th>Date</th><th>Code</th><th>Qt√©</th><th>BT</th></tr></thead><tbody>';
            history.forEach(s=>{html+=`<tr><td>${s.Date||''}</td><td>${s.Code_JDE||''}</td><td>${s.Quantite||''}</td><td>${s.BT_Ref||'-'}</td></tr>`});
            html+='</tbody></table>';
        }
        
        const printArea=document.getElementById('printArea');
        printArea.innerHTML=html;
        window.print();
    }

    function sendWaSig(){
        const text=document.getElementById('sigPreview').textContent;
        window.open('https://wa.me/?text='+encodeURIComponent(text),'_blank');
    }

    function sendWaBT(){
        const text=document.getElementById('btPreview').textContent;
        window.open('https://wa.me/?text='+encodeURIComponent(text),'_blank');
    }
</script>
</body>
</html>
