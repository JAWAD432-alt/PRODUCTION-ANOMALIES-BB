<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>BAHIA - Gestion Production</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f4f8; min-height: 100vh; }
        
        /* ===== LOGIN PAGE ===== */
        .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #0ea5e9 100%); padding: 20px; }
        .login-card { background: white; border-radius: 24px; padding: 40px 30px; width: 100%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-logo { text-align: center; margin-bottom: 30px; }
        .login-logo .icon { font-size: 4em; margin-bottom: 10px; }
        .login-logo h1 { color: #1e40af; font-size: 1.8em; }
        .login-logo p { color: #64748b; font-size: 0.95em; }
        .login-form .input-group { margin-bottom: 20px; }
        .login-form label { display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px; font-size: 0.95em; }
        .login-form input { width: 100%; padding: 16px 18px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 1.05em; background: #f8fafc; transition: all 0.2s; }
        .login-form input:focus { outline: none; border-color: #3b82f6; background: white; }
        .login-form .input-icon { position: relative; }
        .login-form .input-icon span { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 1.2em; }
        .login-form .input-icon input { padding-left: 50px; }
        .btn-login { width: 100%; padding: 18px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none; border-radius: 14px; font-size: 1.15em; font-weight: 700; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); transition: transform 0.2s; }
        .btn-login:active { transform: scale(0.98); }
        .btn-login:disabled { background: #94a3b8; box-shadow: none; }
        .login-error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; font-size: 0.9em; display: none; }
        .login-footer { text-align: center; margin-top: 25px; color: #94a3b8; font-size: 0.85em; }
        .remember-me { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .remember-me input { width: 20px; height: 20px; accent-color: #3b82f6; }
        .remember-me label { color: #64748b; font-weight: 500; margin: 0; }
        
        /* ===== MAIN APP ===== */
        .app-container { display: none; }
        .app-container.active { display: block; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 12px 16px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-left h1 { font-size: 1.1em; font-weight: 700; }
        .header-left .subtitle { font-size: 0.75em; opacity: 0.9; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .user-badge { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; font-size: 0.85em; }
        .user-badge .role { background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        .btn-logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9em; }
        .btn-config { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 1.1em; }
        .db-status { font-size: 0.7em; padding: 3px 10px; background: rgba(255,255,255,0.2); border-radius: 20px; margin-top: 8px; display: inline-block; }
        .db-status.online { background: rgba(16,185,129,0.3); }
        .db-status.offline { background: rgba(239,68,68,0.3); }
        
        /* Tabs */
        .tabs { display: flex; background: white; border-bottom: 2px solid #e2e8f0; position: sticky; top: 58px; z-index: 99; }
        .tab { flex: 1; padding: 12px 8px; text-align: center; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.9em; }
        .tab.active { color: #1e40af; border-bottom-color: #1e40af; background: #eff6ff; }
        .tab.disabled { opacity: 0.4; cursor: not-allowed; }
        .tab .tab-icon { font-size: 1.2em; display: block; margin-bottom: 2px; }
        .tab.hidden { display: none; }
        
        /* Container */
        .container { padding: 14px; max-width: 500px; margin: 0 auto; padding-bottom: 140px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Cards */
        .card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .card.readonly { opacity: 0.85; pointer-events: none; }
        .card.readonly::after { content: "üîí Lecture seule"; position: absolute; top: 10px; right: 10px; background: #64748b; color: white; padding: 4px 10px; border-radius: 8px; font-size: 0.75em; }
        .card { position: relative; }
        .card-title { font-size: 1em; font-weight: 700; color: #1e293b; margin-bottom: 14px; display: flex; align-items: center; gap: 12px; }
        .step { background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; width: 28px; height: 28px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85em; font-weight: 700; flex-shrink: 0; }
        .step.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .step.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .step.purple { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); }
        .step.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        /* Chips */
        .chips { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip { padding: 12px 20px; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 30px; font-size: 1em; cursor: pointer; color: #475569; font-weight: 600; transition: all 0.2s; }
        .chip.selected { background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); border-color: #3b82f6; color: white; }
        .chip.small { padding: 8px 14px; font-size: 0.9em; }
        
        /* Form elements */
        select { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 1em; background: #f8fafc; color: #1e293b; font-weight: 500; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px; }
        select:focus { outline: none; border-color: #3b82f6; }
        input, textarea { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 1em; background: #f8fafc; color: #1e293b; }
        input:focus, textarea:focus { outline: none; border-color: #3b82f6; }
        textarea { resize: none; height: 80px; }
        input[type="file"] { display: none; }
        
        /* Duration */
        .duration-row { display: flex; align-items: center; gap: 12px; }
        .duration-row input { width: 100px; text-align: center; font-size: 1.3em; font-weight: 700; }
        .duration-row span { color: #64748b; font-size: 1em; }
        .quick-durations { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; }
        .quick-dur { padding: 10px 16px; background: #e2e8f0; border: none; border-radius: 20px; font-size: 0.95em; cursor: pointer; color: #475569; font-weight: 600; }
        .quick-dur:active { background: #3b82f6; color: white; }
        
        /* Preview */
        .preview-card { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; }
        .preview-card.orange { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b; }
        .preview-card.purple { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-color: #8b5cf6; }
        .preview-content { background: white; border-radius: 12px; padding: 14px; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; color: #1e293b; max-height: 180px; overflow-y: auto; }
        
        /* Bottom bar */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; padding: 12px 16px; background: white; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); z-index: 1000; }
        .bottom-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-action { flex: 1; min-width: 140px; padding: 16px; color: white; border: none; border-radius: 14px; font-size: 1.05em; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-action.blue { background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-action.green { background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); }
        .btn-action.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .btn-action.purple { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }
        .btn-action:disabled { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); box-shadow: none; }
        .btn-action svg { width: 22px; height: 22px; fill: white; }
        .btn-reset { width: 100%; margin-top: 10px; padding: 12px; background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.95em; font-weight: 600; cursor: pointer; }
        
        /* Tech grid */
        .tech-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .tech-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .tech-item.selected { background: #dbeafe; border-color: #3b82f6; }
        .tech-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: #3b82f6; pointer-events: none; }
        .tech-item .tech-name { font-weight: 600; color: #1e293b; font-size: 0.9em; }
        .tech-item .tech-spec { font-size: 0.7em; color: #64748b; }
        .selected-techs { margin-top: 10px; padding: 10px; background: #f0fdf4; border-radius: 10px; font-size: 0.85em; color: #166534; }
        
        /* Photo */
        .photo-section { margin-top: 10px; }
        .photo-buttons { display: flex; gap: 10px; margin-bottom: 12px; }
        .photo-btn { flex: 1; padding: 12px; border: 2px dashed #e2e8f0; border-radius: 12px; background: #f8fafc; cursor: pointer; text-align: center; font-weight: 600; color: #475569; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .photo-btn:active { background: #dbeafe; border-color: #3b82f6; }
        .photo-btn .icon { font-size: 1.5em; }
        .photo-btn .label { font-size: 0.85em; }
        .photo-preview { position: relative; margin-top: 10px; }
        .photo-preview img { width: 100%; max-height: 180px; object-fit: cover; border-radius: 12px; border: 2px solid #10b981; }
        .photo-preview .remove-photo { position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; background: #ef4444; color: white; border: none; border-radius: 50%; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* Pieces */
        .pieces-list { max-height: 220px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 12px; }
        .piece-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; }
        .piece-item:last-child { border-bottom: none; }
        .piece-item.selected { background: #fef3c7; }
        .piece-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: #f59e0b; pointer-events: none; flex-shrink: 0; }
        .piece-info { flex: 1; min-width: 0; }
        .piece-code { font-weight: 700; color: #1e40af; font-size: 0.8em; }
        .piece-name { font-size: 0.85em; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .piece-stock { font-size: 0.75em; color: #64748b; }
        .piece-qty { display: flex; align-items: center; gap: 4px; }
        .piece-qty input { width: 55px; padding: 6px; text-align: center; font-weight: 700; font-size: 0.95em; }
        .selected-pieces { margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 10px; font-size: 0.8em; color: #92400e; }
        .selected-pieces .piece-tag { display: inline-block; background: white; padding: 3px 8px; border-radius: 6px; margin: 2px; font-weight: 600; }
        
        /* Anomalie selector */
        .ano-list { max-height: 180px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 12px; }
        .ano-item { padding: 12px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; }
        .ano-item:last-child { border-bottom: none; }
        .ano-item.selected { background: #dbeafe; border-left: 4px solid #3b82f6; }
        .ano-item .ano-id { font-weight: 700; color: #1e40af; font-size: 0.85em; }
        .ano-item .ano-date { font-size: 0.75em; color: #64748b; }
        .ano-item .ano-desc { font-size: 0.85em; color: #1e293b; margin-top: 2px; }
        
        /* Status badges */
        .status-badge { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.75em; font-weight: 600; }
        .status-badge.encours { background: #fef3c7; color: #92400e; }
        .status-badge.cloture { background: #d1fae5; color: #065f46; }
        .status-badge.attente { background: #e0e7ff; color: #3730a3; }
        
        /* BT Info */
        .bt-info { background: #eff6ff; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
        .bt-info .bt-id { font-size: 1.1em; font-weight: 700; color: #1e40af; }
        .bt-info .bt-ano { font-size: 0.85em; color: #64748b; }
        
        /* PDR Stats */
        .pdr-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 14px; }
        .pdr-stat { background: #f8fafc; border-radius: 12px; padding: 14px; text-align: center; }
        .pdr-stat .value { font-size: 1.5em; font-weight: 700; color: #1e40af; }
        .pdr-stat .label { font-size: 0.8em; color: #64748b; }
        .pdr-stat.warning .value { color: #f59e0b; }
        .pdr-stat.danger .value { color: #ef4444; }
        
        /* PDR Table */
        .pdr-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .pdr-table th { background: #1e40af; color: white; padding: 10px 8px; text-align: left; font-weight: 600; }
        .pdr-table td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; }
        .pdr-table tr:nth-child(even) { background: #f8fafc; }
        .pdr-table .stock-low { color: #ef4444; font-weight: 700; }
        .pdr-table .stock-ok { color: #10b981; }
        
        /* Modal */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-content { background: white; border-radius: 20px; padding: 24px; max-width: 420px; width: 100%; max-height: 85vh; overflow-y: auto; }
        .modal-content h3 { margin-bottom: 16px; color: #1e293b; }
        .modal-content p { font-size: 0.9em; color: #64748b; margin-bottom: 12px; line-height: 1.5; }
        .modal-content label { font-weight: 600; color: #1e293b; display: block; margin-bottom: 6px; margin-top: 14px; font-size: 0.95em; }
        .modal-content input { margin-bottom: 6px; }
        .modal-content small { font-size: 0.8em; color: #94a3b8; display: block; margin-bottom: 12px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 14px; border-radius: 12px; font-size: 1em; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: #e2e8f0; color: #475569; }
        .btn-modal-save { background: #3b82f6; color: white; }
        .btn-reload { background: #10b981; color: white; margin-top: 10px; width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        
        /* Toasts */
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); padding: 14px 24px; border-radius: 12px; font-weight: 700; z-index: 3000; animation: slideDown 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.2); font-size: 0.95em; }
        .toast.success { background: #10b981; color: white; }
        .toast.error { background: #ef4444; color: white; }
        .toast.info { background: #3b82f6; color: white; }
        @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        /* Success card */
        .success-card { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; text-align: center; padding: 25px; }
        .success-card.orange { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b; }
        .success-card.purple { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-color: #8b5cf6; }
        .success-card .icon { font-size: 3.5em; margin-bottom: 12px; }
        .success-card h3 { color: #166534; margin-bottom: 8px; font-size: 1.1em; }
        .success-card.orange h3 { color: #92400e; }
        .success-card.purple h3 { color: #6b21a8; }
        .success-card p { color: #15803d; font-size: 0.9em; }
        .success-card.orange p { color: #a16207; }
        .success-card.purple p { color: #7c3aed; }
        .success-card .ano-id { background: white; padding: 8px 16px; border-radius: 8px; font-family: monospace; font-size: 1.1em; font-weight: 700; color: #1e40af; margin: 12px 0; display: inline-block; }
        
        /* Overlays */
        .saving-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; color: white; }
        .saving-overlay .loading-spinner { border-color: rgba(255,255,255,0.3); border-top-color: white; width: 50px; height: 50px; }
        .saving-overlay p { margin-top: 20px; font-size: 1.1em; font-weight: 600; }
        .loading { text-align: center; padding: 40px; color: #64748b; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
        .autre-input { margin-top: 12px; }
        
        /* Search box */
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { padding-left: 42px; }
        .search-box .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 1.1em; }
        
        /* Filters */
        .filters { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .filter-chip { padding: 8px 14px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 0.85em; cursor: pointer; color: #475569; font-weight: 500; }
        .filter-chip.active { background: #1e40af; color: white; border-color: #1e40af; }
        
        /* History Table */
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        .history-table th { background: #8b5cf6; color: white; padding: 8px 6px; text-align: left; font-weight: 600; position: sticky; top: 0; }
        .history-table td { padding: 8px 6px; border-bottom: 1px solid #e2e8f0; }
        .history-scroll { max-height: 300px; overflow-y: auto; border-radius: 10px; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <!-- ==================== LOGIN PAGE ==================== -->
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <div class="login-logo">
                <div class="icon">üè≠</div>
                <h1>BAHIA AGADIR</h1>
                <p>Syst√®me de Gestion Production</p>
            </div>
            <div class="login-error" id="loginError">
                ‚ùå Identifiant ou mot de passe incorrect
            </div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label>Identifiant</label>
                    <div class="input-icon">
                        <span>üë§</span>
                        <input type="text" id="loginUsername" placeholder="Votre identifiant" required autocomplete="username">
                    </div>
                </div>
                <div class="input-group">
                    <label>Mot de passe</label>
                    <div class="input-icon">
                        <span>üîí</span>
                        <input type="password" id="loginPassword" placeholder="Votre mot de passe" required autocomplete="current-password">
                    </div>
                </div>
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Se souvenir de moi</label>
                </div>
                <button type="submit" class="btn-login" id="btnLogin">
                    Connexion
                </button>
            </form>
            <div class="login-footer">
                üîê Connexion s√©curis√©e<br>
                <small style="margin-top:8px;display:block;">
                    <a href="#" onclick="showConfig()" style="color:#3b82f6;">‚öôÔ∏è Configuration serveur</a>
                </small>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP ==================== -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="header-left">
                    <h1>üè≠ BAHIA AGADIR</h1>
                    <div class="subtitle">Gestion Production & Maintenance</div>
                </div>
                <div class="header-right">
                    <button class="btn-config" onclick="showConfig()">‚öôÔ∏è</button>
                    <button class="btn-logout" onclick="logout()">üö™</button>
                </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                <div class="user-badge">
                    <span id="currentUserName">-</span>
                    <span class="role" id="currentUserRole">-</span>
                </div>
                <div class="db-status" id="dbStatus">‚è≥ Connexion...</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs" id="tabsContainer">
            <div class="tab" id="tabSignalement" onclick="switchTab('signalement')">
                <span class="tab-icon">üö®</span>
                Signalement
            </div>
            <div class="tab" id="tabMaintenance" onclick="switchTab('maintenance')">
                <span class="tab-icon">üîß</span>
                Maintenance
            </div>
            <div class="tab" id="tabPDR" onclick="switchTab('pdr')">
                <span class="tab-icon">üì¶</span>
                PDR
            </div>
        </div>

        <!-- ==================== ONGLET SIGNALEMENT ==================== -->
        <div id="contentSignalement" class="tab-content">
            <div class="container">
                <div id="loadingSignalement" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement...</p>
                </div>
                
                <div id="appSignalement" class="hidden">
                    <!-- Op√©rateur -->
                    <div class="card">
                        <div class="card-title"><span class="step">1</span> Op√©rateur</div>
                        <select id="operateur" onchange="updatePreviewSignalement()">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    
                    <!-- Ligne -->
                    <div class="card">
                        <div class="card-title"><span class="step">2</span> Ligne de production</div>
                        <div class="chips" id="lignesChips"></div>
                    </div>
                    
                    <!-- Machine -->
                    <div class="card hidden" id="cardMachine">
                        <div class="card-title"><span class="step">3</span> Machine</div>
                        <div class="chips" id="machinesChips"></div>
                    </div>
                    
                    <!-- Zone -->
                    <div class="card hidden" id="cardZone">
                        <div class="card-title"><span class="step">4</span> Zone</div>
                        <select id="zoneSelect" onchange="selectZone(this.value)">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    
                    <!-- Composant -->
                    <div class="card hidden" id="cardComposant">
                        <div class="card-title"><span class="step">5</span> Composant</div>
                        <select id="composantSelect" onchange="selectComposant(this.value)">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                        <div class="autre-input hidden" id="autreComposantDiv">
                            <input type="text" id="autreComposant" placeholder="Pr√©cisez le composant..." oninput="updatePreviewSignalement()">
                        </div>
                    </div>
                    
                    <!-- Anomalie -->
                    <div class="card hidden" id="cardAnomalie">
                        <div class="card-title"><span class="step">6</span> Type d'anomalie</div>
                        <select id="anomalieSelect" onchange="selectAnomalie(this.value)">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                        <div class="autre-input hidden" id="autreAnomalieDiv">
                            <input type="text" id="autreAnomalie" placeholder="D√©crivez l'anomalie..." oninput="updatePreviewSignalement()">
                        </div>
                    </div>
                    
                    <!-- Techniciens -->
                    <div class="card hidden" id="cardTechniciens">
                        <div class="card-title"><span class="step">7</span> Technicien(s)</div>
                        <div class="tech-grid" id="techniciensGrid"></div>
                        <div class="selected-techs hidden" id="selectedTechs"></div>
                    </div>
                    
                    <!-- Dur√©e -->
                    <div class="card hidden" id="cardDuree">
                        <div class="card-title"><span class="step">8</span> Dur√©e intervention</div>
                        <div class="duration-row">
                            <input type="number" id="duree" min="1" max="999" placeholder="0" oninput="updatePreviewSignalement()">
                            <span>minutes</span>
                        </div>
                        <div class="quick-durations">
                            <button class="quick-dur" onclick="setDuree(5)">5</button>
                            <button class="quick-dur" onclick="setDuree(10)">10</button>
                            <button class="quick-dur" onclick="setDuree(15)">15</button>
                            <button class="quick-dur" onclick="setDuree(30)">30</button>
                            <button class="quick-dur" onclick="setDuree(60)">60</button>
                        </div>
                    </div>
                    
                    <!-- Photo -->
                    <div class="card hidden" id="cardPhoto">
                        <div class="card-title"><span class="step">9</span> Photo (optionnel)</div>
                        <div class="photo-section">
                            <div class="photo-buttons">
                                <label class="photo-btn" for="cameraInput">
                                    <span class="icon">üì∑</span>
                                    <span class="label">Cam√©ra</span>
                                </label>
                                <label class="photo-btn" for="galleryInput">
                                    <span class="icon">üñºÔ∏è</span>
                                    <span class="label">Galerie</span>
                                </label>
                            </div>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handlePhoto(this)">
                            <input type="file" id="galleryInput" accept="image/*" onchange="handlePhoto(this)">
                            <div class="photo-preview hidden" id="photoPreview">
                                <img id="photoImg" src="" alt="Photo">
                                <button class="remove-photo" onclick="removePhoto()">‚úï</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Commentaire -->
                    <div class="card hidden" id="cardComment">
                        <div class="card-title"><span class="step">10</span> Commentaire</div>
                        <textarea id="comment" placeholder="D√©tails suppl√©mentaires..." oninput="updatePreviewSignalement()"></textarea>
                    </div>
                    
                    <!-- Aper√ßu -->
                    <div class="card preview-card hidden" id="cardPreview">
                        <div class="card-title">üìã Aper√ßu</div>
                        <div class="preview-content" id="preview"></div>
                    </div>
                    
                    <!-- Success -->
                    <div class="card success-card hidden" id="successSignalement">
                        <div class="icon">‚úÖ</div>
                        <h3>Anomalie Enregistr√©e !</h3>
                        <p>Sauvegard√©e dans la base de donn√©es</p>
                        <div class="ano-id" id="anoIdSig">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ONGLET MAINTENANCE ==================== -->
        <div id="contentMaintenance" class="tab-content">
            <div class="container">
                <div id="loadingMaintenance" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement des anomalies...</p>
                </div>
                
                <div id="appMaintenance" class="hidden">
                    <!-- S√©lection anomalie -->
                    <div class="card">
                        <div class="card-title"><span class="step orange">1</span> Anomalie √† traiter</div>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="searchAnomalie" placeholder="Rechercher..." oninput="filterAnomalies()">
                        </div>
                        <div class="ano-list" id="anomaliesList"></div>
                        <button class="btn-reload" onclick="loadAnomaliesEnCours()" style="margin-top:8px;">üîÑ Actualiser</button>
                    </div>
                    
                    <!-- Info BT -->
                    <div class="card hidden" id="cardBT">
                        <div class="card-title"><span class="step orange">2</span> Bon de Travail</div>
                        <div class="bt-info">
                            <div class="bt-id" id="btId">BT-YYYYMMDD-XXXX</div>
                            <div class="bt-ano">Anomalie: <span id="btAnoRef">-</span></div>
                        </div>
                        <label style="font-weight:600;color:#1e293b;margin-bottom:6px;display:block;font-size:0.9em;">Technicien responsable</label>
                        <select id="techResponsable" onchange="updatePreviewMaint()">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    
                    <!-- Diagnostic -->
                    <div class="card hidden" id="cardDiagnostic">
                        <div class="card-title"><span class="step orange">3</span> Diagnostic</div>
                        <select id="causeSelect" onchange="updatePreviewMaint()">
                            <option value="">-- Type de cause --</option>
                            <option value="Usure normale">Usure normale</option>
                            <option value="D√©faut mat√©riel">D√©faut mat√©riel</option>
                            <option value="Erreur op√©rateur">Erreur op√©rateur</option>
                            <option value="Probl√®me r√©glage">Probl√®me de r√©glage</option>
                            <option value="Manque lubrification">Manque de lubrification</option>
                            <option value="Corps √©tranger">Corps √©tranger</option>
                            <option value="D√©faut √©lectrique">D√©faut √©lectrique</option>
                            <option value="D√©faut pneumatique">D√©faut pneumatique</option>
                            <option value="Autre">Autre</option>
                        </select>
                        <textarea id="diagnostic" placeholder="D√©tail du diagnostic..." style="margin-top:10px;" oninput="updatePreviewMaint()"></textarea>
                    </div>
                    
                    <!-- Action -->
                    <div class="card hidden" id="cardAction">
                        <div class="card-title"><span class="step orange">4</span> Action corrective</div>
                        <select id="actionSelect" onchange="updatePreviewMaint()">
                            <option value="">-- Type d'action --</option>
                            <option value="Remplacement pi√®ce">Remplacement de pi√®ce</option>
                            <option value="R√©paration">R√©paration</option>
                            <option value="R√©glage">R√©glage / Ajustement</option>
                            <option value="Nettoyage">Nettoyage</option>
                            <option value="Lubrification">Lubrification</option>
                            <option value="Resserrage">Resserrage</option>
                            <option value="Autre">Autre</option>
                        </select>
                        <textarea id="actionDetail" placeholder="D√©tail de l'action..." style="margin-top:10px;" oninput="updatePreviewMaint()"></textarea>
                    </div>
                    
                    <!-- Pi√®ces JDE -->
                    <div class="card hidden" id="cardPieces">
                        <div class="card-title"><span class="step purple">5</span> Pi√®ces utilis√©es</div>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="searchPiece" placeholder="Rechercher code/nom..." oninput="filterPieces()">
                        </div>
                        <div class="pieces-list" id="piecesList"></div>
                        <div class="selected-pieces hidden" id="selectedPieces"></div>
                    </div>
                    
                    <!-- Dur√©e -->
                    <div class="card hidden" id="cardDureeMaint">
                        <div class="card-title"><span class="step orange">6</span> Dur√©e totale</div>
                        <div class="duration-row">
                            <input type="number" id="dureeMaint" min="1" max="999" placeholder="0" oninput="updatePreviewMaint()">
                            <span>minutes</span>
                        </div>
                        <div class="quick-durations">
                            <button class="quick-dur" onclick="setDureeMaint(15)">15</button>
                            <button class="quick-dur" onclick="setDureeMaint(30)">30</button>
                            <button class="quick-dur" onclick="setDureeMaint(60)">60</button>
                            <button class="quick-dur" onclick="setDureeMaint(120)">120</button>
                        </div>
                    </div>
                    
                    <!-- Statut -->
                    <div class="card hidden" id="cardStatut">
                        <div class="card-title"><span class="step green">7</span> Statut</div>
                        <div class="chips">
                            <div class="chip small" onclick="selectStatut(this, 'En cours')">üîÑ En cours</div>
                            <div class="chip small" onclick="selectStatut(this, 'Cl√¥tur√©')">‚úÖ Cl√¥tur√©</div>
                            <div class="chip small" onclick="selectStatut(this, 'Attente pi√®ce')">‚è≥ Attente</div>
                        </div>
                    </div>
                    
                    <!-- Aper√ßu BT -->
                    <div class="card preview-card orange hidden" id="cardPreviewMaint">
                        <div class="card-title">üìã Aper√ßu BT</div>
                        <div class="preview-content" id="previewMaint"></div>
                    </div>
                    
                    <!-- Success -->
                    <div class="card success-card orange hidden" id="successMaintenance">
                        <div class="icon">üîß</div>
                        <h3>BT Enregistr√© !</h3>
                        <p>Intervention sauvegard√©e</p>
                        <div class="ano-id" id="btIdSuccess">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ONGLET PDR ==================== -->
        <div id="contentPDR" class="tab-content">
            <div class="container">
                <div id="loadingPDR" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement du stock...</p>
                </div>
                
                <div id="appPDR" class="hidden">
                    <!-- Stats -->
                    <div class="pdr-stats">
                        <div class="pdr-stat">
                            <div class="value" id="statTotalPieces">0</div>
                            <div class="label">Total pi√®ces</div>
                        </div>
                        <div class="pdr-stat warning">
                            <div class="value" id="statStockBas">0</div>
                            <div class="label">Stock bas</div>
                        </div>
                    </div>
                    
                    <!-- Nouvelle sortie -->
                    <div class="card">
                        <div class="card-title"><span class="step purple">1</span> Nouvelle sortie PDR</div>
                        
                        <label style="font-weight:600;font-size:0.9em;margin-bottom:6px;display:block;">Machine concern√©e</label>
                        <select id="pdrMachine" onchange="updatePreviewPDR()">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                        
                        <label style="font-weight:600;font-size:0.9em;margin:12px 0 6px;display:block;">Motif de sortie</label>
                        <select id="pdrMotif" onchange="updatePreviewPDR()">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Maintenance pr√©ventive">Maintenance pr√©ventive</option>
                            <option value="Maintenance corrective">Maintenance corrective</option>
                            <option value="Remplacement usure">Remplacement usure</option>
                            <option value="Stock tampon">Stock tampon machine</option>
                            <option value="Autre">Autre</option>
                        </select>
                        
                        <label style="font-weight:600;font-size:0.9em;margin:12px 0 6px;display:block;">R√©f√©rence BT (optionnel)</label>
                        <input type="text" id="pdrBtRef" placeholder="Ex: BT-20241209-0001" oninput="updatePreviewPDR()">
                    </div>
                    
                    <!-- S√©lection pi√®ces -->
                    <div class="card">
                        <div class="card-title"><span class="step purple">2</span> Pi√®ces √† sortir</div>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="searchPiecePDR" placeholder="Rechercher code/nom..." oninput="filterPiecesPDR()">
                        </div>
                        <div class="filters" id="pdrFilters">
                            <div class="filter-chip active" onclick="filterByType(this, 'all')">Tous</div>
                            <div class="filter-chip" onclick="filterByType(this, 'mecanique')">M√©canique</div>
                            <div class="filter-chip" onclick="filterByType(this, 'electrique')">√âlectrique</div>
                            <div class="filter-chip" onclick="filterByType(this, 'pneumatique')">Pneumatique</div>
                        </div>
                        <div class="pieces-list" id="piecesListPDR"></div>
                        <div class="selected-pieces hidden" id="selectedPiecesPDR"></div>
                    </div>
                    
                    <!-- Demandeur -->
                    <div class="card">
                        <div class="card-title"><span class="step purple">3</span> Demandeur</div>
                        <select id="pdrDemandeur" onchange="updatePreviewPDR()">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    
                    <!-- Aper√ßu sortie -->
                    <div class="card preview-card purple hidden" id="cardPreviewPDR">
                        <div class="card-title">üìã Aper√ßu sortie</div>
                        <div class="preview-content" id="previewPDR"></div>
                    </div>
                    
                    <!-- Success -->
                    <div class="card success-card purple hidden" id="successPDR">
                        <div class="icon">üì¶</div>
                        <h3>Sortie Enregistr√©e !</h3>
                        <p>Stock mis √† jour</p>
                        <div class="ano-id" id="sortieIdPDR">-</div>
                    </div>
                    
                    <!-- Historique -->
                    <div class="card">
                        <div class="card-title"><span class="step red">üìä</span> Historique sorties</div>
                        <div class="filters" style="margin-bottom:10px;">
                            <div class="filter-chip active" onclick="filterHistory(this, 'today')">Aujourd'hui</div>
                            <div class="filter-chip" onclick="filterHistory(this, 'week')">7 jours</div>
                            <div class="filter-chip" onclick="filterHistory(this, 'month')">30 jours</div>
                        </div>
                        <div class="history-scroll">
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Code</th>
                                        <th>Qt√©</th>
                                        <th>Machine</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody">
                                    <tr><td colspan="4" style="text-align:center;color:#64748b;">Aucune sortie</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <button class="btn-reload" onclick="loadHistorySorties()" style="margin-top:8px;">üîÑ Actualiser</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Bars -->
        <div class="bottom-bar hidden" id="bottomSignalement">
            <div class="bottom-buttons" id="btnsMainSig">
                <button class="btn-action blue" id="btnSaveSig" onclick="saveSignalement()" disabled>üíæ Enregistrer</button>
                <button class="btn-action green" id="btnWASig" onclick="sendWASignalement()" disabled>
                    <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                </button>
            </div>
            <button class="btn-reset hidden" id="btnResetSig" onclick="resetSignalement()">üîÑ Nouveau signalement</button>
        </div>
        
        <div class="bottom-bar hidden" id="bottomMaintenance">
            <div class="bottom-buttons" id="btnsMainMaint">
                <button class="btn-action orange" id="btnSaveMaint" onclick="saveMaintenance()" disabled>üíæ Enregistrer BT</button>
                <button class="btn-action green" id="btnWAMaint" onclick="sendWAMaint()" disabled>
                    <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                </button>
            </div>
            <button class="btn-reset hidden" id="btnResetMaint" onclick="resetMaintenance()">üîÑ Nouvelle intervention</button>
        </div>
        
        <div class="bottom-bar hidden" id="bottomPDR">
            <div class="bottom-buttons" id="btnsMainPDR">
                <button class="btn-action purple" id="btnSavePDR" onclick="savePDR()" disabled>üíæ Valider sortie</button>
            </div>
            <button class="btn-reset hidden" id="btnResetPDR" onclick="resetPDR()">üîÑ Nouvelle sortie</button>
        </div>
    </div>

    <!-- Modal Config -->
    <div class="modal hidden" id="configModal">
        <div class="modal-content">
            <h3>‚öôÔ∏è Configuration</h3>
            <label>URL du Script Google</label>
            <input type="text" id="configUrl" placeholder="https://script.google.com/...">
            <small>URL de d√©ploiement Apps Script</small>
            <label>Token de s√©curit√©</label>
            <input type="text" id="configToken" placeholder="Votre token secret">
            <button class="btn-reload" onclick="testConnection()">üîÑ Tester connexion</button>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideConfig()">Annuler</button>
                <button class="btn-modal-save" onclick="saveConfig()">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- Saving Overlay -->
    <div class="saving-overlay hidden" id="savingOverlay">
        <div class="loading-spinner"></div>
        <p id="savingText">Enregistrement...</p>
    </div>

    <script>
    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let currentUser = null;
    let dbData = null;
    let allAnomalies = [];
    let allPieces = [];
    let historySorties = [];
    
    // R√¥les et permissions
    const ROLES = {
        admin: { label: 'Admin', tabs: ['signalement', 'maintenance', 'pdr'], canEdit: true },
        production: { label: 'Production', tabs: ['signalement'], canEdit: true },
        maintenance: { label: 'Maintenance', tabs: ['maintenance', 'pdr'], canEdit: true },
        direction: { label: 'Direction', tabs: ['signalement', 'maintenance', 'pdr'], canEdit: false }
    };
    
    // Signalement
    let dataSig = { ligne: '', machine: '', zone: '', composant: '', anomalie: '', techniciens: [] };
    let photoFile = null, photoDataUrl = null, savedAnoId = null;
    
    // Maintenance
    let dataMaint = { anomalie: null, pieces: [], statut: '' };
    let savedBtId = null;
    
    // PDR
    let dataPDR = { pieces: [] };
    let savedSortieId = null;

    // ============================================
    // AUTHENTIFICATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
        checkRememberedUser();
    });

    function checkRememberedUser() {
        const savedUser = localStorage.getItem('bahia_user');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                showApp();
            } catch(e) {
                localStorage.removeItem('bahia_user');
            }
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const remember = document.getElementById('rememberMe').checked;
        
        document.getElementById('btnLogin').disabled = true;
        document.getElementById('btnLogin').textContent = 'Connexion...';
        document.getElementById('loginError').style.display = 'none';
        
        try {
            const scriptUrl = localStorage.getItem('bahia_script_url');
            const token = localStorage.getItem('bahia_token');
            
            if (!scriptUrl || !token) {
                showLoginError('‚öôÔ∏è Configurez d\'abord le serveur');
                return;
            }
            
            const url = `${scriptUrl}?token=${encodeURIComponent(token)}&action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success && result.user) {
                currentUser = result.user;
                if (remember) {
                    localStorage.setItem('bahia_user', JSON.stringify(currentUser));
                }
                showApp();
            } else {
                showLoginError(result.error || 'Identifiants incorrects');
            }
        } catch (error) {
            showLoginError('Erreur de connexion au serveur');
        } finally {
            document.getElementById('btnLogin').disabled = false;
            document.getElementById('btnLogin').textContent = 'Connexion';
        }
    }

    function showLoginError(msg) {
        const el = document.getElementById('loginError');
        el.textContent = '‚ùå ' + msg;
        el.style.display = 'block';
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('bahia_user');
        document.getElementById('appContainer').classList.remove('active');
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
    }

    function showApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('appContainer').classList.add('active');
        
        // Afficher info utilisateur
        document.getElementById('currentUserName').textContent = currentUser.nom;
        document.getElementById('currentUserRole').textContent = ROLES[currentUser.role]?.label || currentUser.role;
        
        // Configurer les onglets selon le r√¥le
        setupTabs();
        
        // Charger les donn√©es
        loadData();
    }

    function setupTabs() {
        const role = ROLES[currentUser.role] || ROLES.production;
        const allowedTabs = role.tabs;
        
        // Afficher/masquer les onglets
        document.getElementById('tabSignalement').classList.toggle('hidden', !allowedTabs.includes('signalement'));
        document.getElementById('tabMaintenance').classList.toggle('hidden', !allowedTabs.includes('maintenance'));
        document.getElementById('tabPDR').classList.toggle('hidden', !allowedTabs.includes('pdr'));
        
        // Activer le premier onglet disponible
        if (allowedTabs.length > 0) {
            switchTab(allowedTabs[0]);
        }
    }

    // ============================================
    // CONFIGURATION
    // ============================================
    function loadConfig() {
        document.getElementById('configUrl').value = localStorage.getItem('bahia_script_url') || '';
        document.getElementById('configToken').value = localStorage.getItem('bahia_token') || '';
    }

    function showConfig() {
        document.getElementById('configModal').classList.remove('hidden');
    }

    function hideConfig() {
        document.getElementById('configModal').classList.add('hidden');
    }

    function saveConfig() {
        const url = document.getElementById('configUrl').value.trim();
        const token = document.getElementById('configToken').value.trim();
        if (url) localStorage.setItem('bahia_script_url', url);
        if (token) localStorage.setItem('bahia_token', token);
        hideConfig();
        showToast('‚úÖ Configuration enregistr√©e');
        if (currentUser) loadData();
    }

    async function testConnection() {
        const url = document.getElementById('configUrl').value.trim();
        const token = document.getElementById('configToken').value.trim();
        
        try {
            const response = await fetch(`${url}?token=${encodeURIComponent(token)}&action=test`);
            const result = await response.json();
            if (result.success) {
                showToast('‚úÖ Connexion OK');
            } else {
                showToast('‚ùå ' + (result.error || 'Erreur'), 'error');
            }
        } catch(e) {
            showToast('‚ùå Erreur de connexion', 'error');
        }
    }

    // ============================================
    // CHARGEMENT DONN√âES
    // ============================================
    async function loadData() {
        const scriptUrl = localStorage.getItem('bahia_script_url');
        const token = localStorage.getItem('bahia_token');
        
        if (!scriptUrl || !token) {
            document.getElementById('dbStatus').textContent = '‚ö†Ô∏è Non configur√©';
            document.getElementById('dbStatus').className = 'db-status offline';
            return;
        }
        
        try {
            const url = `${scriptUrl}?token=${encodeURIComponent(token)}`;
            const response = await fetch(url);
            dbData = await response.json();
            
            if (dbData.error) throw new Error(dbData.error);
            
            document.getElementById('dbStatus').textContent = '‚úÖ Connect√©';
            document.getElementById('dbStatus').className = 'db-status online';
            
            initSignalement();
            initMaintenance();
            initPDR();
            
        } catch (error) {
            document.getElementById('dbStatus').textContent = '‚ùå Erreur';
            document.getElementById('dbStatus').className = 'db-status offline';
            console.error(error);
        }
    }

    // ============================================
    // TABS
    // ============================================
    function switchTab(tab) {
        const role = ROLES[currentUser?.role] || ROLES.production;
        if (!role.tabs.includes(tab)) return;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.bottom-bar').forEach(b => b.classList.add('hidden'));
        
        document.getElementById('tab' + capitalize(tab)).classList.add('active');
        document.getElementById('content' + capitalize(tab)).classList.add('active');
        document.getElementById('bottom' + capitalize(tab)).classList.remove('hidden');
        
        if (tab === 'maintenance') loadAnomaliesEnCours();
        if (tab === 'pdr') loadHistorySorties();
    }

    function capitalize(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // ============================================
    // SIGNALEMENT
    // ============================================
    function initSignalement() {
        document.getElementById('loadingSignalement').classList.add('hidden');
        document.getElementById('appSignalement').classList.remove('hidden');
        
        // Op√©rateurs
        const opSelect = document.getElementById('operateur');
        opSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
        (dbData.operateurs || []).forEach(op => {
            opSelect.innerHTML += `<option value="${op.Nom}">${op.Nom}</option>`;
        });
        
        // Lignes
        const lignes = [...new Set((dbData.machines || []).map(m => m.Ligne))];
        const lignesDiv = document.getElementById('lignesChips');
        lignesDiv.innerHTML = '';
        lignes.forEach(l => {
            lignesDiv.innerHTML += `<div class="chip" onclick="selectLigne(this, '${l}')">${l}</div>`;
        });
        
        // Techniciens
        const techGrid = document.getElementById('techniciensGrid');
        techGrid.innerHTML = '';
        (dbData.techniciens || []).forEach(t => {
            techGrid.innerHTML += `
                <div class="tech-item" onclick="toggleTech(this, '${t.Nom}')">
                    <input type="checkbox">
                    <div>
                        <div class="tech-name">${t.Nom}</div>
                        <div class="tech-spec">${t.Specialite || ''}</div>
                    </div>
                </div>`;
        });
    }

    function selectLigne(el, v) {
        document.querySelectorAll('#lignesChips .chip').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        dataSig.ligne = v;
        dataSig.machine = dataSig.zone = dataSig.composant = dataSig.anomalie = '';
        
        const machines = (dbData.machines || []).filter(m => m.Ligne === v);
        const div = document.getElementById('machinesChips');
        div.innerHTML = '';
        machines.forEach(m => {
            div.innerHTML += `<div class="chip" onclick="selectMachine(this, '${m.Machine}')">${m.Machine}</div>`;
        });
        
        show('cardMachine');
        hide(['cardZone','cardComposant','cardAnomalie','cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']);
        updatePreviewSignalement();
    }

    function selectMachine(el, v) {
        document.querySelectorAll('#machinesChips .chip').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        dataSig.machine = v;
        dataSig.zone = dataSig.composant = dataSig.anomalie = '';
        
        const zones = (dbData.zones || []).filter(z => z.Machine === v);
        const sel = document.getElementById('zoneSelect');
        sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
        zones.forEach(z => sel.innerHTML += `<option value="${z.Zone}">${z.Zone}</option>`);
        
        show('cardZone');
        hide(['cardComposant','cardAnomalie','cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']);
        updatePreviewSignalement();
    }

    function selectZone(v) {
        dataSig.zone = v;
        dataSig.composant = dataSig.anomalie = '';
        if (!v) { hide(['cardComposant','cardAnomalie','cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']); return; }
        
        const comps = (dbData.composants || []).filter(c => c.Zone === v);
        const sel = document.getElementById('composantSelect');
        sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
        comps.forEach(c => sel.innerHTML += `<option value="${c.Composant}">${c.Composant}</option>`);
        sel.innerHTML += '<option value="Autre">‚ûï Autre...</option>';
        
        show('cardComposant');
        hide(['cardAnomalie','cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']);
        updatePreviewSignalement();
    }

    function selectComposant(v) {
        dataSig.composant = v;
        dataSig.anomalie = '';
        document.getElementById('autreComposantDiv').classList.toggle('hidden', v !== 'Autre');
        if (!v) { hide(['cardAnomalie','cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']); return; }
        
        const sel = document.getElementById('anomalieSelect');
        sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
        (dbData.anomalies || []).forEach(a => sel.innerHTML += `<option value="${a.Anomalie}">${a.Anomalie}</option>`);
        sel.innerHTML += '<option value="Autre">‚ûï Autre...</option>';
        
        show('cardAnomalie');
        hide(['cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']);
        updatePreviewSignalement();
    }

    function selectAnomalie(v) {
        dataSig.anomalie = v;
        document.getElementById('autreAnomalieDiv').classList.toggle('hidden', v !== 'Autre');
        if (!v) { hide(['cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']); return; }
        show(['cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']);
        updatePreviewSignalement();
    }

    function toggleTech(el, nom) {
        el.classList.toggle('selected');
        el.querySelector('input').checked = el.classList.contains('selected');
        if (el.classList.contains('selected')) {
            dataSig.techniciens.push(nom);
        } else {
            dataSig.techniciens = dataSig.techniciens.filter(t => t !== nom);
        }
        const div = document.getElementById('selectedTechs');
        div.classList.toggle('hidden', dataSig.techniciens.length === 0);
        div.innerHTML = '<strong>S√©lectionn√©s:</strong> ' + dataSig.techniciens.join(', ');
        updatePreviewSignalement();
    }

    function setDuree(v) { document.getElementById('duree').value = v; updatePreviewSignalement(); }

    function handlePhoto(input) {
        const file = input.files[0];
        if (file) {
            compressImage(file, 1024, 0.7).then(r => {
                photoFile = r.file;
                photoDataUrl = r.dataUrl;
                document.getElementById('photoImg').src = photoDataUrl;
                document.getElementById('photoPreview').classList.remove('hidden');
                updatePreviewSignalement();
            });
        }
    }

    function removePhoto() {
        photoFile = photoDataUrl = null;
        document.getElementById('photoPreview').classList.add('hidden');
        document.getElementById('cameraInput').value = '';
        document.getElementById('galleryInput').value = '';
        updatePreviewSignalement();
    }

    function compressImage(file, maxSize, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > maxSize) { h = Math.round(h * maxSize / w); w = maxSize; } }
                    else { if (h > maxSize) { w = Math.round(w * maxSize / h); h = maxSize; } }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    fetch(dataUrl).then(r => r.blob()).then(blob => {
                        resolve({ file: new File([blob], 'photo.jpg', {type:'image/jpeg'}), dataUrl });
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function updatePreviewSignalement() {
        const op = document.getElementById('operateur').value;
        const comp = dataSig.composant === 'Autre' ? document.getElementById('autreComposant').value || 'Autre' : dataSig.composant;
        const ano = dataSig.anomalie === 'Autre' ? document.getElementById('autreAnomalie').value || 'Autre' : dataSig.anomalie;
        const duree = document.getElementById('duree').value;
        const comment = document.getElementById('comment').value;
        
        let msg = `üö® *SIGNALEMENT ANOMALIE*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        if (op) msg += `üë∑ Op√©rateur: ${op}\n`;
        if (dataSig.ligne) msg += `üè≠ Ligne: ${dataSig.ligne}\n`;
        if (dataSig.machine) msg += `‚öôÔ∏è Machine: ${dataSig.machine}\n`;
        if (dataSig.zone) msg += `üìç Zone: ${dataSig.zone}\n`;
        if (comp) msg += `üîß Composant: ${comp}\n`;
        if (ano) msg += `‚ö†Ô∏è Anomalie: ${ano}\n`;
        if (dataSig.techniciens.length) msg += `üë®‚Äçüîß Techniciens: ${dataSig.techniciens.join(', ')}\n`;
        if (duree) msg += `‚è±Ô∏è Dur√©e: ${duree} min\n`;
        if (photoFile) msg += `üì∑ Photo jointe\n`;
        if (comment) msg += `üí¨ ${comment}\n`;
        
        document.getElementById('preview').textContent = msg;
        
        const complete = op && dataSig.ligne && dataSig.machine && dataSig.zone && dataSig.composant && dataSig.anomalie && dataSig.techniciens.length && duree;
        document.getElementById('btnSaveSig').disabled = !complete || !ROLES[currentUser?.role]?.canEdit;
        document.getElementById('btnWASig').disabled = !dataSig.anomalie;
    }

    async function saveSignalement() {
        const scriptUrl = localStorage.getItem('bahia_script_url');
        const token = localStorage.getItem('bahia_token');
        
        document.getElementById('savingOverlay').classList.remove('hidden');
        document.getElementById('savingText').textContent = 'Enregistrement...';
        
        try {
            const postData = {
                action: 'saveAnomalie',
                token,
                operateur: document.getElementById('operateur').value,
                ligne: dataSig.ligne,
                machine: dataSig.machine,
                zone: dataSig.zone,
                composant: dataSig.composant === 'Autre' ? document.getElementById('autreComposant').value : dataSig.composant,
                anomalie: dataSig.anomalie === 'Autre' ? document.getElementById('autreAnomalie').value : dataSig.anomalie,
                techniciens: dataSig.techniciens.join(', '),
                duree: document.getElementById('duree').value,
                commentaire: document.getElementById('comment').value,
                photo: photoDataUrl || '',
                userId: currentUser?.id
            };
            
            const response = await fetch(scriptUrl, {
                method: 'POST', mode: 'cors', redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(postData)
            });
            const result = await response.json();
            document.getElementById('savingOverlay').classList.add('hidden');
            
            if (result.error) throw new Error(result.error);
            
            savedAnoId = result.id;
            document.getElementById('anoIdSig').textContent = savedAnoId;
            
            hide(['cardMachine','cardZone','cardComposant','cardAnomalie','cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']);
            document.querySelectorAll('#appSignalement > .card').forEach(c => c.classList.add('hidden'));
            document.getElementById('successSignalement').classList.remove('hidden');
            
            document.getElementById('btnsMainSig').classList.add('hidden');
            document.getElementById('btnResetSig').classList.remove('hidden');
            
            showToast('‚úÖ Anomalie enregistr√©e');
        } catch(e) {
            document.getElementById('savingOverlay').classList.add('hidden');
            showToast('‚ùå ' + e.message, 'error');
        }
    }

    function sendWASignalement() {
        const msg = document.getElementById('preview').textContent + (savedAnoId ? '\n\nüÜî ' + savedAnoId : '');
        window.location.href = 'whatsapp://send?text=' + encodeURIComponent(msg);
    }

    function resetSignalement() {
        dataSig = { ligne: '', machine: '', zone: '', composant: '', anomalie: '', techniciens: [] };
        photoFile = photoDataUrl = savedAnoId = null;
        
        document.getElementById('operateur').value = '';
        document.getElementById('duree').value = '';
        document.getElementById('comment').value = '';
        document.querySelectorAll('#lignesChips .chip, #machinesChips .chip, .tech-item').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.tech-item input').forEach(c => c.checked = false);
        document.getElementById('selectedTechs').classList.add('hidden');
        removePhoto();
        
        document.getElementById('successSignalement').classList.add('hidden');
        document.querySelectorAll('#appSignalement > .card').forEach((c,i) => { if(i < 2) c.classList.remove('hidden'); });
        hide(['cardMachine','cardZone','cardComposant','cardAnomalie','cardTechniciens','cardDuree','cardPhoto','cardComment','cardPreview']);
        
        document.getElementById('btnsMainSig').classList.remove('hidden');
        document.getElementById('btnResetSig').classList.add('hidden');
        
        updatePreviewSignalement();
    }

    // ============================================
    // MAINTENANCE
    // ============================================
    function initMaintenance() {
        document.getElementById('loadingMaintenance').classList.add('hidden');
        document.getElementById('appMaintenance').classList.remove('hidden');
        
        const sel = document.getElementById('techResponsable');
        sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
        (dbData.techniciens || []).forEach(t => sel.innerHTML += `<option value="${t.Nom}">${t.Nom}</option>`);
        
        allPieces = dbData.pieces || [];
        renderPieces(allPieces, 'piecesList', 'maintenance');
    }

    async function loadAnomaliesEnCours() {
        const scriptUrl = localStorage.getItem('bahia_script_url');
        const token = localStorage.getItem('bahia_token');
        try {
            const url = `${scriptUrl}?token=${encodeURIComponent(token)}&action=getAnomaliesEnCours`;
            const response = await fetch(url);
            const data = await response.json();
            allAnomalies = data.anomalies || [];
            renderAnomalies(allAnomalies);
        } catch(e) { console.error(e); }
    }

    function renderAnomalies(list) {
        const div = document.getElementById('anomaliesList');
        if (!list.length) {
            div.innerHTML = '<div style="padding:20px;text-align:center;color:#64748b;">Aucune anomalie en cours</div>';
            return;
        }
        div.innerHTML = '';
        list.forEach((a, i) => {
            const cls = a.Statut === 'Cl√¥tur√©' ? 'cloture' : (a.Statut === 'Attente pi√®ce' ? 'attente' : 'encours');
            div.innerHTML += `
                <div class="ano-item" onclick="selectAnoMaint(${i})">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span class="ano-id">${a.ID}</span>
                        <span class="status-badge ${cls}">${a.Statut || 'En cours'}</span>
                    </div>
                    <div class="ano-date">${a.Date} ${a.Heure || ''}</div>
                    <div class="ano-desc">${a.Machine} ‚Üí ${a.Anomalie}</div>
                </div>`;
        });
    }

    function filterAnomalies() {
        const s = document.getElementById('searchAnomalie').value.toLowerCase();
        renderAnomalies(allAnomalies.filter(a => a.ID.toLowerCase().includes(s) || a.Machine.toLowerCase().includes(s) || a.Anomalie.toLowerCase().includes(s)));
    }

    function selectAnoMaint(i) {
        dataMaint.anomalie = allAnomalies[i];
        document.querySelectorAll('.ano-item').forEach((el, j) => el.classList.toggle('selected', i === j));
        
        const now = new Date();
        const btId = 'BT-' + now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0') + '-' + String(Math.floor(Math.random()*9000)+1000);
        document.getElementById('btId').textContent = btId;
        document.getElementById('btAnoRef').textContent = dataMaint.anomalie.ID;
        
        show(['cardBT','cardDiagnostic','cardAction','cardPieces','cardDureeMaint','cardStatut','cardPreviewMaint']);
        updatePreviewMaint();
    }

    function renderPieces(list, containerId, mode) {
        const div = document.getElementById(containerId);
        if (!list.length) { div.innerHTML = '<div style="padding:20px;text-align:center;color:#64748b;">Aucune pi√®ce</div>'; return; }
        div.innerHTML = '';
        const selected = mode === 'maintenance' ? dataMaint.pieces : dataPDR.pieces;
        list.forEach((p, i) => {
            const sel = selected.find(x => x.code === p.Code_JDE);
            const qty = sel ? sel.qty : 1;
            div.innerHTML += `
                <div class="piece-item ${sel ? 'selected' : ''}" data-idx="${i}">
                    <input type="checkbox" ${sel ? 'checked' : ''} onclick="togglePiece(${i}, '${mode}')">
                    <div class="piece-info" onclick="togglePiece(${i}, '${mode}')">
                        <div class="piece-code">${p.Code_JDE}</div>
                        <div class="piece-name">${p.Designation}</div>
                        <div class="piece-stock">Stock: ${p.Stock || 0} ${p.Unite || 'U'}</div>
                    </div>
                    <div class="piece-qty ${sel ? '' : 'hidden'}">
                        <input type="number" min="1" value="${qty}" onchange="updatePieceQty(${i}, this.value, '${mode}')" onclick="event.stopPropagation()">
                    </div>
                </div>`;
        });
    }

    function filterPieces() {
        const s = document.getElementById('searchPiece').value.toLowerCase();
        renderPieces(allPieces.filter(p => p.Code_JDE.toLowerCase().includes(s) || p.Designation.toLowerCase().includes(s)), 'piecesList', 'maintenance');
    }

    function togglePiece(i, mode) {
        const piece = allPieces[i];
        const arr = mode === 'maintenance' ? dataMaint.pieces : dataPDR.pieces;
        const idx = arr.findIndex(x => x.code === piece.Code_JDE);
        if (idx >= 0) arr.splice(idx, 1);
        else arr.push({ code: piece.Code_JDE, designation: piece.Designation, qty: 1, unite: piece.Unite || 'U' });
        
        renderPieces(allPieces, mode === 'maintenance' ? 'piecesList' : 'piecesListPDR', mode);
        updateSelectedPieces(mode);
        if (mode === 'maintenance') updatePreviewMaint(); else updatePreviewPDR();
    }

    function updatePieceQty(i, qty, mode) {
        const piece = allPieces[i];
        const arr = mode === 'maintenance' ? dataMaint.pieces : dataPDR.pieces;
        const item = arr.find(x => x.code === piece.Code_JDE);
        if (item) item.qty = parseInt(qty) || 1;
        updateSelectedPieces(mode);
        if (mode === 'maintenance') updatePreviewMaint(); else updatePreviewPDR();
    }

    function updateSelectedPieces(mode) {
        const arr = mode === 'maintenance' ? dataMaint.pieces : dataPDR.pieces;
        const div = document.getElementById(mode === 'maintenance' ? 'selectedPieces' : 'selectedPiecesPDR');
        if (!arr.length) { div.classList.add('hidden'); return; }
        div.classList.remove('hidden');
        div.innerHTML = '<strong>S√©lectionn√©es:</strong><br>' + arr.map(p => `<span class="piece-tag">${p.code} x${p.qty}</span>`).join('');
    }

    function selectStatut(el, v) {
        document.querySelectorAll('#cardStatut .chip').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        dataMaint.statut = v;
        updatePreviewMaint();
    }

    function setDureeMaint(v) { document.getElementById('dureeMaint').value = v; updatePreviewMaint(); }

    function updatePreviewMaint() {
        const ano = dataMaint.anomalie;
        const tech = document.getElementById('techResponsable').value;
        const cause = document.getElementById('causeSelect').value;
        const diag = document.getElementById('diagnostic').value;
        const action = document.getElementById('actionSelect').value;
        const detail = document.getElementById('actionDetail').value;
        const duree = document.getElementById('dureeMaint').value;
        
        let msg = `üîß *BON DE TRAVAIL*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        msg += `üìã BT: ${document.getElementById('btId').textContent}\n`;
        if (ano) {
            msg += `üîó Anomalie: ${ano.ID}\n`;
            msg += `‚öôÔ∏è Machine: ${ano.Machine}\n`;
            msg += `‚ö†Ô∏è Probl√®me: ${ano.Anomalie}\n`;
        }
        msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        if (tech) msg += `üë®‚Äçüîß Technicien: ${tech}\n`;
        if (cause) msg += `üîç Cause: ${cause}\n`;
        if (diag) msg += `üìù Diagnostic: ${diag}\n`;
        if (action) msg += `üõ†Ô∏è Action: ${action}\n`;
        if (detail) msg += `üìù D√©tail: ${detail}\n`;
        if (dataMaint.pieces.length) {
            msg += `üì¶ Pi√®ces:\n`;
            dataMaint.pieces.forEach(p => msg += `   ‚Ä¢ ${p.code} x${p.qty}\n`);
        }
        if (duree) msg += `‚è±Ô∏è Dur√©e: ${duree} min\n`;
        if (dataMaint.statut) msg += `‚úÖ Statut: ${dataMaint.statut}\n`;
        
        document.getElementById('previewMaint').textContent = msg;
        
        const complete = ano && tech && cause && action && duree && dataMaint.statut;
        document.getElementById('btnSaveMaint').disabled = !complete || !ROLES[currentUser?.role]?.canEdit;
        document.getElementById('btnWAMaint').disabled = !ano;
    }

    async function saveMaintenance() {
        const scriptUrl = localStorage.getItem('bahia_script_url');
        const token = localStorage.getItem('bahia_token');
        
        document.getElementById('savingOverlay').classList.remove('hidden');
        
        try {
            const postData = {
                action: 'saveBT',
                token,
                btId: document.getElementById('btId').textContent,
                anomalieId: dataMaint.anomalie.ID,
                technicien: document.getElementById('techResponsable').value,
                cause: document.getElementById('causeSelect').value,
                diagnostic: document.getElementById('diagnostic').value,
                actionType: document.getElementById('actionSelect').value,
                actionDetail: document.getElementById('actionDetail').value,
                pieces: JSON.stringify(dataMaint.pieces),
                duree: document.getElementById('dureeMaint').value,
                statut: dataMaint.statut,
                userId: currentUser?.id
            };
            
            const response = await fetch(scriptUrl, {
                method: 'POST', mode: 'cors', redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(postData)
            });
            const result = await response.json();
            document.getElementById('savingOverlay').classList.add('hidden');
            
            if (result.error) throw new Error(result.error);
            
            savedBtId = result.btId || document.getElementById('btId').textContent;
            document.getElementById('btIdSuccess').textContent = savedBtId;
            
            document.querySelectorAll('#appMaintenance > .card').forEach(c => c.classList.add('hidden'));
            document.getElementById('successMaintenance').classList.remove('hidden');
            
            document.getElementById('btnsMainMaint').classList.add('hidden');
            document.getElementById('btnResetMaint').classList.remove('hidden');
            
            showToast('‚úÖ BT enregistr√©');
        } catch(e) {
            document.getElementById('savingOverlay').classList.add('hidden');
            showToast('‚ùå ' + e.message, 'error');
        }
    }

    function sendWAMaint() {
        window.location.href = 'whatsapp://send?text=' + encodeURIComponent(document.getElementById('previewMaint').textContent);
    }

    function resetMaintenance() {
        dataMaint = { anomalie: null, pieces: [], statut: '' };
        savedBtId = null;
        
        document.getElementById('searchAnomalie').value = '';
        document.getElementById('techResponsable').value = '';
        document.getElementById('causeSelect').value = '';
        document.getElementById('diagnostic').value = '';
        document.getElementById('actionSelect').value = '';
        document.getElementById('actionDetail').value = '';
        document.getElementById('dureeMaint').value = '';
        document.getElementById('searchPiece').value = '';
        document.querySelectorAll('#cardStatut .chip, .ano-item').forEach(c => c.classList.remove('selected'));
        document.getElementById('selectedPieces').classList.add('hidden');
        
        renderPieces(allPieces, 'piecesList', 'maintenance');
        renderAnomalies(allAnomalies);
        
        document.getElementById('successMaintenance').classList.add('hidden');
        document.querySelector('#appMaintenance > .card').classList.remove('hidden');
        hide(['cardBT','cardDiagnostic','cardAction','cardPieces','cardDureeMaint','cardStatut','cardPreviewMaint']);
        
        document.getElementById('btnsMainMaint').classList.remove('hidden');
        document.getElementById('btnResetMaint').classList.add('hidden');
        
        updatePreviewMaint();
    }

    // ============================================
    // PDR
    // ============================================
    function initPDR() {
        document.getElementById('loadingPDR').classList.add('hidden');
        document.getElementById('appPDR').classList.remove('hidden');
        
        // Machines
        const machines = [...new Set((dbData.machines || []).map(m => m.Machine))];
        const sel = document.getElementById('pdrMachine');
        sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
        machines.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
        
        // Demandeurs (techniciens)
        const dem = document.getElementById('pdrDemandeur');
        dem.innerHTML = '<option value="">-- S√©lectionner --</option>';
        (dbData.techniciens || []).forEach(t => dem.innerHTML += `<option value="${t.Nom}">${t.Nom}</option>`);
        
        // Stats
        document.getElementById('statTotalPieces').textContent = allPieces.length;
        const lowStock = allPieces.filter(p => (p.Stock || 0) <= 5).length;
        document.getElementById('statStockBas').textContent = lowStock;
        
        renderPieces(allPieces, 'piecesListPDR', 'pdr');
    }

    function filterPiecesPDR() {
        const s = document.getElementById('searchPiecePDR').value.toLowerCase();
        renderPieces(allPieces.filter(p => p.Code_JDE.toLowerCase().includes(s) || p.Designation.toLowerCase().includes(s)), 'piecesListPDR', 'pdr');
    }

    function filterByType(el, type) {
        document.querySelectorAll('#pdrFilters .filter-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        // Filtrer par type (simplifi√© - √† am√©liorer avec vraie colonne Type)
        if (type === 'all') {
            renderPieces(allPieces, 'piecesListPDR', 'pdr');
        } else {
            const keywords = {
                mecanique: ['roulement', 'courroie', 'joint', 'palier', 'cha√Æne', 'pignon'],
                electrique: ['capteur', 'variateur', 'contacteur', 'relais', 'bouton', 'voyant', 'fusible'],
                pneumatique: ['v√©rin', 'electrovanne', 'filtre', 'pressostat', 'tuyau', 'raccord']
            };
            const kw = keywords[type] || [];
            const filtered = allPieces.filter(p => kw.some(k => p.Designation.toLowerCase().includes(k)));
            renderPieces(filtered, 'piecesListPDR', 'pdr');
        }
    }

    function updatePreviewPDR() {
        const machine = document.getElementById('pdrMachine').value;
        const motif = document.getElementById('pdrMotif').value;
        const btRef = document.getElementById('pdrBtRef').value;
        const demandeur = document.getElementById('pdrDemandeur').value;
        
        let msg = `üì¶ *SORTIE PDR*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        if (machine) msg += `‚öôÔ∏è Machine: ${machine}\n`;
        if (motif) msg += `üìã Motif: ${motif}\n`;
        if (btRef) msg += `üîó BT: ${btRef}\n`;
        if (demandeur) msg += `üë®‚Äçüîß Demandeur: ${demandeur}\n`;
        if (dataPDR.pieces.length) {
            msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüì¶ Pi√®ces:\n`;
            dataPDR.pieces.forEach(p => msg += `   ‚Ä¢ ${p.code} x${p.qty}\n`);
        }
        
        document.getElementById('previewPDR').textContent = msg;
        document.getElementById('cardPreviewPDR').classList.toggle('hidden', !dataPDR.pieces.length);
        
        const complete = machine && motif && demandeur && dataPDR.pieces.length;
        document.getElementById('btnSavePDR').disabled = !complete || !ROLES[currentUser?.role]?.canEdit;
    }

    async function savePDR() {
        const scriptUrl = localStorage.getItem('bahia_script_url');
        const token = localStorage.getItem('bahia_token');
        
        document.getElementById('savingOverlay').classList.remove('hidden');
        
        try {
            const postData = {
                action: 'saveSortiePDR',
                token,
                machine: document.getElementById('pdrMachine').value,
                motif: document.getElementById('pdrMotif').value,
                btRef: document.getElementById('pdrBtRef').value,
                demandeur: document.getElementById('pdrDemandeur').value,
                pieces: JSON.stringify(dataPDR.pieces),
                userId: currentUser?.id
            };
            
            const response = await fetch(scriptUrl, {
                method: 'POST', mode: 'cors', redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(postData)
            });
            const result = await response.json();
            document.getElementById('savingOverlay').classList.add('hidden');
            
            if (result.error) throw new Error(result.error);
            
            savedSortieId = result.sortieId;
            document.getElementById('sortieIdPDR').textContent = savedSortieId;
            
            document.querySelectorAll('#appPDR > .card').forEach(c => c.classList.add('hidden'));
            document.getElementById('successPDR').classList.remove('hidden');
            
            document.getElementById('btnsMainPDR').classList.add('hidden');
            document.getElementById('btnResetPDR').classList.remove('hidden');
            
            showToast('‚úÖ Sortie enregistr√©e');
            loadHistorySorties();
        } catch(e) {
            document.getElementById('savingOverlay').classList.add('hidden');
            showToast('‚ùå ' + e.message, 'error');
        }
    }

    function resetPDR() {
        dataPDR = { pieces: [] };
        savedSortieId = null;
        
        document.getElementById('pdrMachine').value = '';
        document.getElementById('pdrMotif').value = '';
        document.getElementById('pdrBtRef').value = '';
        document.getElementById('pdrDemandeur').value = '';
        document.getElementById('searchPiecePDR').value = '';
        document.getElementById('selectedPiecesPDR').classList.add('hidden');
        
        renderPieces(allPieces, 'piecesListPDR', 'pdr');
        
        document.getElementById('successPDR').classList.add('hidden');
        document.querySelectorAll('#appPDR > .card').forEach(c => c.classList.remove('hidden'));
        hide(['cardPreviewPDR']);
        
        document.getElementById('btnsMainPDR').classList.remove('hidden');
        document.getElementById('btnResetPDR').classList.add('hidden');
        
        updatePreviewPDR();
    }

    async function loadHistorySorties() {
        const scriptUrl = localStorage.getItem('bahia_script_url');
        const token = localStorage.getItem('bahia_token');
        try {
            const url = `${scriptUrl}?token=${encodeURIComponent(token)}&action=getHistorySorties`;
            const response = await fetch(url);
            const data = await response.json();
            historySorties = data.sorties || [];
            renderHistorySorties(historySorties);
        } catch(e) { console.error(e); }
    }

    function renderHistorySorties(list) {
        const tbody = document.getElementById('historyBody');
        if (!list.length) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#64748b;">Aucune sortie</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        list.slice(0, 50).forEach(s => {
            tbody.innerHTML += `<tr><td>${s.Date}</td><td>${s.Code_JDE}</td><td>${s.Quantite}</td><td>${s.Machine || '-'}</td></tr>`;
        });
    }

    function filterHistory(el, period) {
        document.querySelectorAll('#appPDR .filters .filter-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        // Filtrer par p√©riode (simplifi√©)
        renderHistorySorties(historySorties);
    }

    // ============================================
    // UTILITAIRES
    // ============================================
    function hide(ids) { (Array.isArray(ids) ? ids : [ids]).forEach(id => document.getElementById(id)?.classList.add('hidden')); }
    function show(ids) { (Array.isArray(ids) ? ids : [ids]).forEach(id => document.getElementById(id)?.classList.remove('hidden')); }

    function showToast(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(e => {});
    }
    </script>
</body>
</html>
